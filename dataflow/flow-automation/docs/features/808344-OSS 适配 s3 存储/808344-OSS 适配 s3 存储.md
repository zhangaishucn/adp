# 808344 【Autoflow】OSS 适配 s3 存储 —— 逻辑设计

---

## 一、需求分析

### 1.1 需求背景

#### 需求信息

| 字段     | 内容                          |
| -------- | ----------------------------- |
| 需求号   | 808344                        |
| 类型     | Feature                       |
| 标题     | 【Autoflow】OSS 适配 s3 存储  |
| 状态     | In Realizing                  |
| 需求来源 | 产品规划                     |

#### 需求场景

当前系统的对象存储（OSS）功能依赖于商业版的 OSS Gateway Manager 服务。在社区版部署场景下，缺少独立的 OSS Gateway Manager 服务，导致对象存储功能无法正常使用。

为了支持社区版部署，需要将 OSS 网关适配为支持 S3 兼容存储，使系统可以：

- 直接连接 S3 兼容的对象存储服务（如 AWS S3、MinIO、Ceph RGW 等）
- 在社区版环境下正常使用对象存储功能
- 保持与商业版相同的 API 接口，无需修改业务代码
- 支持多 S3 连接配置和默认连接选择

#### 用户期望

本次需求目标包括：

1. **支持社区版对象存储**
   - 直接连接 S3 兼容存储
   - 无需依赖 OSS Gateway Manager 服务
   - 支持标准 S3 协议

2. **保持接口兼容性**
   - 保持与商业版相同的 API 接口
   - 业务代码无需修改
   - 无缝切换存储后端

3. **灵活的配置管理**
   - 支持多 S3 连接配置
   - 支持默认连接设置
   - 通过配置文件管理连接信息

4. **完整的文件操作支持**
   - 文件上传
   - 文件下载
   - 文件删除
   - 获取文件元数据
   - 生成预签名下载链接

5. **版本区分机制**
   - 通过 edition 字段区分社区版和商业版
   - 自动选择合适的存储实现

---

### 1.2 用户故事

| 角色           | 痛点（Why）                          | 活动（What）                 | 价值（Value）                   |
| -------------- | ------------------------------------ | ---------------------------- | ------------------------------ |
| 社区版部署者   | 社区版缺少 OSS Gateway Manager 服务 | 配置 S3 兼容存储             | 在社区版环境使用对象存储功能   |
| 系统运维人员   | 需要管理多个存储后端                 | 配置多个 S3 连接和默认连接   | 灵活管理存储资源               |
| 应用开发者     | 希望代码在不同版本间保持一致         | 使用统一的 OSS 接口          | 降低开发和维护成本             |
| 数据流设计者   | 需要在数据流中使用对象存储           | 使用 S3 存储上传/下载文件    | 支持数据处理流程的文件操作     |

---

## 二、业务功能设计

### 2.1 概念与术语

| 中文     | 英文            | 定义                                       |
| -------- | --------------- | ------------------------------------------ |
| S3 连接  | S3 Connection   | S3 兼容存储的连接配置，包含 endpoint、region、凭证等 |
| S3 客户端 | S3 Client       | 基于 AWS SDK 的 S3 客户端，用于与 S3 兼容存储交互 |
| 版本     | Edition         | 系统版本标识，区分社区版（community）和商业版（commercial） |
| OSS 网关 | OSS Gateway     | 对象存储网关接口，提供统一的文件操作 API  |
| 预签名链接 | Presigned URL   | 临时授权的下载链接，具有过期时间           |

---

### 2.2 业务用例

#### 用例名称

**配置和使用 S3 存储**

#### 用例说明

| 项目     | 描述                                       |
| -------- | ------------------------------------------ |
| 参与者   | 系统运维人员、应用开发者                   |
| 前置条件 | 已部署系统；S3 兼容存储服务可用；已配置 S3 连接信息 |
| 后置条件 | S3 存储配置完成并成功执行文件操作         |

---

### 2.3 业务功能定义

#### 版本区分机制

##### Edition 字段

在 `Server` 配置中新增 `Edition` 字段，用于区分社区版和商业版：

| 字段名  | 类型    | 可选值                     | 描述           |
| ------- | ------- | -------------------------- | -------------- |
| Edition | string  | `community` / `commercial` | 系统版本标识   |

##### 网关选择逻辑

根据 `Edition` 字段自动选择合适的 OSS 网关实现：

- **社区版（community）**：使用 `ossGatetWayS3` 实现，直接连接 S3 兼容存储
- **商业版（commercial）**：使用 `ossGatetway` 实现，通过 OSS Gateway Manager 服务

---

#### S3 连接配置

##### 配置文件

S3 连接配置存储在 `/conf/s3.yaml` 文件中：

```yaml
default: "default"
connections:
  - name: default
    endpoint: s3.amazonaws.com
    region: us-east-1
    accessKeyID: ""
    secretAccessKey: ""
    bucketName: "dataflow"
```

##### 连接参数

| 参数名         | 类型   | 是否可选 | 描述                                   |
| -------------- | ------ | -------- | -------------------------------------- |
| name           | string | N        | 连接名称，用于标识唯一连接             |
| endpoint       | string | Y        | S3 服务端点，如 `s3.amazonaws.com`     |
| region         | string | N        | AWS 区域，如 `us-east-1`               |
| accessKeyID    | string | N        | 访问密钥 ID                            |
| secretAccessKey| string | N        | 访问密钥                               |
| bucketName     | string | N        | 存储桶名称                             |

##### 配置管理

- S3 配置在服务启动时加载
- 支持多个连接配置
- 通过 `default` 字段指定默认连接
- 连接初始化失败时记录错误日志，不影响其他连接

---

#### S3 网关实现

##### 核心接口

`ossGatetWayS3` 实现 `OssGateWay` 接口，提供以下方法：

| 方法名             | 描述                           |
| ------------------ | ------------------------------ |
| UploadFile         | 上传文件                       |
| SimpleUpload       | 文件上传                       |
| DownloadFile       | 下载文件到内存                 |
| DownloadFile2Local | 下载文件到本地                 |
| DeleteFile         | 删除文件                       |
| GetDownloadURL     | 生成预签名下载链接             |
| GetObjectMeta      | 获取文件元数据                 |
| GetAvaildOSS       | 获取可用的 OSS ID              |
| NewReader          | 创建文件读取器                 |

##### 文件上传

**文件上传（SimpleUpload）**
- 直接调用 S3 `PutObject` API
- 支持指定文件大小

##### 文件下载

**下载到内存（DownloadFile）**
- 调用 S3 `GetObject` API
- 自动重试机制（最多 3 次）
- 校验下载完整性

**下载到本地（DownloadFile2Local）**
- 先下载到内存
- 再写入本地文件
- 返回文件大小

##### 预签名链接

**生成下载链接（GetDownloadURL）**
- 基于 AWS SDK 的 `PresignGetObject` API
- 支持设置过期时间（秒）
- 返回临时授权的下载 URL

##### 文件元数据

**获取文件大小（GetObjectMeta）**
- 调用 S3 `HeadObject` API
- 返回 `Content-Length` 字段

##### 文件删除

**删除文件（DeleteFile）**
- 调用 S3 `DeleteObject` API
- 支持删除指定 key 的对象

---

#### 部署配置

##### values.yaml 配置

在 `flowAutomation.s3` 下添加 S3 配置：

```yaml
flowAutomation:
  s3:
    default: "default"
    connections:
      - name: default
        endpoint: s3.amazonaws.com
        region: us-east-1
        accessKeyID: ""
        secretAccessKey: ""
        bucketName: "dataflow"
```

##### ConfigMap 配置

在 ConfigMap 中添加 S3 配置挂载：

```yaml
S3: |
  {{- toYaml .Values.flowAutomation.s3 | toYaml | nindent 4 }}
```

##### Deployment 配置

在 Deployment 中添加 S3 配置文件挂载：

```yaml
- name: s3-config
  mountPath: /conf/s3.yaml
  subPath: s3.yaml
```

---

### 2.4 业务流程

#### 2.4.1 OSS 网关初始化流程

```
开始
  ↓
调用 NewOssGateWay()
  ↓
读取配置中的 Edition 字段
  ↓
Edition == "community"?
  ├─ 是 → 创建 ossGatetWayS3 实例
  │        ↓
  │      加载 /conf/s3.yaml 配置
  │        ↓
  │      初始化所有 S3 连接
  │        ↓
  │      返回 S3 网关实例
  │
  └─ 否 → 创建 ossGatetway 实例
           ↓
         配置 OSS Gateway Manager 地址
           ↓
         返回 OSS 网关实例
  ↓
结束
```

#### 2.4.2 S3 连接初始化流程

```
开始
  ↓
打开 /conf/s3.yaml 文件
  ↓
解析 YAML 配置
  ↓
遍历 connections 列表
  ↓
为每个连接创建 S3Connection 实例
  ↓
调用 InitClient() 初始化 AWS 客户端
  ↓
初始化成功？
  ├─ 是 → 将连接添加到 connMap
  └─ 否 → 记录错误日志，跳过该连接
  ↓
返回 S3 实例
  ↓
结束
```

#### 2.4.3 文件上传流程

```
开始
  ↓
接收文件和大小
  ↓
读取文件内容到内存
  ↓
调用 S3 PutObject API
  ↓
返回上传结果
  ↓
结束
```

#### 2.4.4 文件下载流程

```
开始
  ↓
调用 S3 GetObject API
  ↓
读取文件内容到内存
  ↓
结束
```

#### 2.4.5 获取可用 OSS 流程

```
开始
  ↓
调用 GetDefaultConnection()
  ↓
默认连接可用？
  ├─ 是 → 返回默认连接名称
  └─ 否 → 遍历所有连接
           ↓
         找到第一个可用的连接？
           ├─ 是 → 返回该连接名称
           └─ 否 → 返回错误 "no available s3 connection"
  ↓
结束
```
---

## 三、技术设计

### 3.1 架构设计

#### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     业务层                                   │
│  (数据流、工作流、算子等)                                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ 调用统一接口
                      ↓
┌─────────────────────────────────────────────────────────────┐
│                  OSS Gateway 接口层                         │
│  OssGateWay Interface                                       │
│  - UploadFile                                               │
│  - DownloadFile                                             │
│  - DeleteFile                                               │
│  - GetDownloadURL                                           │
│  - GetObjectMeta                                            │
│  - GetAvaildOSS                                             │
└─────────────────────┬───────────────────────────────────────┘
                      │
          ┌───────────┴───────────┐
          │                       │
          ↓                       ↓
┌─────────────────────┐  ┌─────────────────────┐
│   社区版实现        │  │   商业版实现        │
│   ossGatetWayS3     │  │   ossGatetway       │
└──────────┬──────────┘  └──────────┬──────────┘
           │                        │
           │ 直接连接               │ 通过 HTTP
           ↓                        ↓
┌─────────────────────┐  ┌─────────────────────┐
│   S3 兼容存储       │  │ OSS Gateway Manager │
│   (AWS S3, MinIO)   │  │      服务           │
└─────────────────────┘  └─────────────────────┘
```

#### 模块划分

| 模块名称         | 文件路径                              | 职责                           |
| ---------------- | ------------------------------------- | ------------------------------ |
| S3 网关实现      | `drivenadapters/ossgateway_s3.go`    | 社区版 S3 网关实现             |
| 商业版网关实现   | `drivenadapters/ossgateway.go`       | 商业版 OSS Gateway 实现       |
| S3 连接管理      | `libs/go/s3/conn.go`                 | S3 连接配置和客户端初始化      |
| S3 配置管理      | `libs/go/s3/s3.go`                   | S3 配置加载和连接管理          |
| 配置定义         | `common/config.go`                    | Edition 字段和配置结构定义     |

---

### 3.2 数据结构设计

#### S3Connection

```go
type S3Connection struct {
    client          *awsS3.Client    // AWS S3 客户端
    Name            string           // 连接名称
    Endpoint        string           // S3 服务端点
    Region          string           // AWS 区域
    AccessKeyID     string           // 访问密钥 ID
    SecretAccessKey string           // 访问密钥
    BucketName      string           // 存储桶名称
}
```

#### S3

```go
type S3 struct {
    connMap      map[string]*S3Connection  // 连接映射表
    Default      string                     // 默认连接名称
    Connections  []*S3Connection            // 连接列表
}
```

#### Edition

```go
type Edition string

const (
    EditionCommunity  Edition = "community"
    EditionCommercial Edition = "commercial"
)
```

---

### 3.3 接口设计

#### OssGateWay 接口

```go
type OssGateWay interface {
    UploadFile(ctx context.Context, ossID, key string, internalRequest bool, file io.Reader, size int64) error
    SimpleUpload(ctx context.Context, ossID, key string, internalRequest bool, file io.Reader) error
    DownloadFile(ctx context.Context, ossID, key string, internalRequest bool, opts ...OssOpt) ([]byte, error)
    DownloadFile2Local(ctx context.Context, ossID, key string, internalRequest bool, filePath string, opts ...OssOpt) (int64, error)
    DeleteFile(ctx context.Context, ossID, key string, internalRequest bool) error
    GetDownloadURL(ctx context.Context, ossID, key string, expires int64, internalRequest bool, opts ...OssOpt) (string, error)
    GetObjectMeta(ctx context.Context, ossID, key string, internalRequest bool, opts ...OssOpt) (int64, error)
    GetAvaildOSS(ctx context.Context) (string, error)
    NewReader(ossID string, ossKey string, opts ...OssOpt) *Reader
}
```

#### S3Connection 方法

```go
func (c *S3Connection) InitClient() error
func (c *S3Connection) GetDownloadURL(ctx context.Context, key string, expires int64) (string, error)
func (c *S3Connection) DeleteObject(ctx context.Context, key string) error
func (c *S3Connection) UploadObject(ctx context.Context, key string, file io.Reader, size int64) error
func (c *S3Connection) GetObjectSize(ctx context.Context, key string) (int64, error)
func (c *S3Connection) GetObject(ctx context.Context, key string) (io.ReadCloser, error)
```

#### S3 方法

```go
func NewS3() *S3
func (s *S3) GetConnection(name string) *S3Connection
func (s *S3) GetDefaultConnection() *S3Connection
func (s *S3) GetAvailableConnections() []*S3Connection
func (s *S3) GetAvailableConnection() *S3Connection
```

---

## 四、部署说明

### 4.1 前置条件

- 已部署 S3 兼容存储服务（如 AWS S3、MinIO、Ceph RGW 等）
- 已创建存储桶（Bucket）
- 已获取访问密钥（Access Key ID 和 Secret Access Key）

### 4.2 配置步骤

1. **修改 values.yaml**

   ```yaml
   flowAutomation:
     service:
       edition: "community"  # 设置为社区版
     s3:
       default: "default"
       connections:
         - name: default
           endpoint: your-s3-endpoint.com
           region: us-east-1
           accessKeyID: "your-access-key-id"
           secretAccessKey: "your-secret-access-key"
           bucketName: "your-bucket-name"
   ```

2. **部署应用**

   ```bash
   helm upgrade --install dataflow ./charts/dataflow -f values.yaml
   ```

3. **验证配置**

   - 检查 Pod 日志确认 S3 连接初始化成功
   - 测试文件上传/下载功能

### 4.3 配置示例

```yaml
flowAutomation:
  s3:
    default: "primary"
    connections:
      - name: primary
        endpoint: s3.amazonaws.com
        region: us-east-1
        accessKeyID: "AKIAIOSFODNN7EXAMPLE"
        secretAccessKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
        bucketName: "dataflow-primary"
      - name: backup
        endpoint: minio.example.com:9000
        region: us-east-1
        accessKeyID: "minioadmin"
        secretAccessKey: "minioadmin"
        bucketName: "dataflow-backup"
```

---

## 五、附录

### 5.1 相关文件清单

| 文件路径                                                    | 说明                           |
| ----------------------------------------------------------- | ------------------------------ |
| `drivenadapters/ossgateway.go`                             | OSS Gateway 接口定义和商业版实现 |
| `drivenadapters/ossgateway_s3.go`                          | 社区版 S3 网关实现             |
| `libs/go/s3/conn.go`                                       | S3 连接配置和客户端实现        |
| `libs/go/s3/s3.go`                                         | S3 配置管理和连接池            |
| `common/config.go`                                         | Edition 字段和配置结构定义    |
| `charts/dataflow/values.yaml`                              | Helm Chart 配置文件            |
| `charts/dataflow/templates/flow-automation/configmap.yaml` | ConfigMap 模板                 |
| `charts/dataflow/templates/deployment.yaml`                | Deployment 模板                |

### 5.2 依赖包

| 包名                                       | 版本  | 用途                   |
| ------------------------------------------ | ----- | ---------------------- |
| `github.com/aws/aws-sdk-go-v2`             | v2.x  | AWS SDK v2             |
| `github.com/aws/aws-sdk-go-v2/config`     | v2.x  | AWS 配置加载           |
| `github.com/aws/aws-sdk-go-v2/credentials`| v2.x  | AWS 凭证管理           |
| `github.com/aws/aws-sdk-go-v2/service/s3` | v2.x  | S3 服务客户端          |
| `github.com/goccy/go-yaml`                 | v1.x  | YAML 解析              |

### 5.3 参考资料

- [AWS SDK for Go v2 文档](https://aws.github.io/aws-sdk-go-v2/docs/)
- [S3 API 文档](https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html)
- [MinIO 文档](https://docs.min.io/)
