openapi: 3.0.3
info:
  title: Agent App Observability API
  description: Agent应用可观测性API接口文档
  version: 1.0.0
  contact:
    name: DevOps Team
    email: devops@example.com

servers:
  - url: https://api.example.com/api/agent-app/v1
    description: Production server

paths:
  /observability/agent/{agent_id}/detail:
    post:
      summary: 查询指定Agent的可观测信息
      description: 查询指定Agent的可观测信息，返回结果包含Agent的配置信息以及可观测性的指标，支持时间过滤
      operationId: getAgentObservability
      tags:
        - Observability
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentObservabilityReq'
      responses:
        '200':
          description: 成功返回Agent可观测信息
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentObservabilityResp'
        '400':
          description: 请求参数错误
        '404':
          description: Agent不存在
        '500':
          description: 服务器内部错误

  /observability/agent/{agent_id}/conversation:
    post:
      summary: 查询Agent下的所有对话列表
      description: 查询Agent下的所有对话列表，支持分页和根据对话title模糊查询
      operationId: getConversationList
      tags:
        - Observability
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConversationListObservabilityReq'
      responses:
        '200':
          description: 成功返回对话列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationListObservabilityResp'
        '400':
          description: 请求参数错误
        '404':
          description: Agent不存在
        '500':
          description: 服务器内部错误

  /observability/agent/{agent_id}/conversation/{conversation_id}/session:
    post:
      summary: 获取指定对话的session列表
      description: 获取指定对话的session列表，包含session的详细信息
      operationId: getSessionList
      tags:
        - Observability
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent ID
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
          description: 对话ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionListObservabilityReq'
      responses:
        '200':
          description: 成功返回session列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListObservabilityResp'
        '400':
          description: 请求参数错误
        '404':
          description: Agent或对话不存在
        '500':
          description: 服务器内部错误

  /observability/agent/{agent_id}/conversation/{conversation_id}/session/{session_id}/detail:
    post:
      summary: 获取指定session的详情信息
      description: 获取指定session的详情信息，包含多个指标
      operationId: getSessionDetail
      tags:
        - Observability
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent ID
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
          description: 对话ID
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionDetailObservabilityReq'
      responses:
        '200':
          description: 成功返回session详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionDetailObservabilityResp'
        '400':
          description: 请求参数错误
        '404':
          description: Agent、对话或session不存在
        '500':
          description: 服务器内部错误

  /observability/agent/{agent_id}/conversation/{conversation_id}/session/{session_id}/run:
    post:
      summary: 获取指定session下的run列表
      description: 获取指定对话的session下的run列表，返回每个run的详情列表
      operationId: getRunList
      tags:
        - Observability
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent ID
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
          description: 对话ID
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunListObservabilityReq'
      responses:
        '200':
          description: 成功返回run列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunListObservabilityResp'
        '400':
          description: 请求参数错误
        '404':
          description: Agent、对话或session不存在
        '500':
          description: 服务器内部错误

  /observability/agent/{agent_id}/conversation/{conversation_id}/session/{session_id}/run/{run_id}/detail:
    post:
      summary: 获取指定run的详情信息
      description: 获取指定run的详情信息，包含run的完整信息
      operationId: getRunDetail
      tags:
        - Observability
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent ID
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
          description: 对话ID
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session ID
        - name: run_id
          in: path
          required: true
          schema:
            type: string
          description: Run ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunDetailObservabilityReq'
      responses:
        '200':
          description: 成功返回run详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunDetailObservabilityResp'
        '400':
          description: 请求参数错误
        '404':
          description: Agent、对话、session或run不存在
        '500':
          description: 服务器内部错误

components:
  schemas:
    AgentObservabilityReq:
      type: object
      required:
        - agent_id
        - agent_version
      properties:
        agent_id:
          type: string
          description: Agent ID
        agent_version:
          type: string
          description: Agent版本
        include_config:
          type: boolean
          description: 是否包含agent配置信息，默认值为false
          default: false
        start:
          type: integer
          format: int64
          description: 开始时间戳，单位到毫秒，例如：1646360670123
        end:
          type: integer
          format: int64
          description: 结束时间戳，单位到毫秒，例如：1646360670123

    AgentObservabilityResp:
      type: object
      properties:
        agent:
          $ref: '#/components/schemas/Agent'
        total_requests:
          type: integer
          description: 总请求数
        total_sessions:
          type: integer
          description: 总会话数
        avg_session_rounds:
          type: integer
          description: 平均会话轮次
        run_success_rate:
          type: number
          format: float
          description: Run成功率
        avg_execute_duration:
          type: integer
          description: 平均执行时长
        avg_ttft_duration:
          type: integer
          description: 平均首token响应时间
        tool_success_rate:
          type: number
          format: float
          description: 工具调用成功率

    Agent:
      type: object
      properties:
        id:
          type: string
          description: Agent ID
        version:
          type: string
          description: Agent版本
        key:
          type: string
          description: Agent Key
        is_built_in:
          type: integer
          description: 是否为内置Agent
        name:
          type: string
          description: Agent名称
        category_id:
          type: string
          description: 分类ID
        category_name:
          type: string
          description: 分类名称
        profile:
          type: string
          description: Agent简介
        config:
          type: object
          description: Agent配置信息
        avatar_type:
          type: integer
          description: 头像类型
        avatar:
          type: string
          description: 头像URL
        product_id:
          type: integer
          description: 产品ID
        product_name:
          type: string
          description: 产品名称
        publish_info:
          $ref: '#/components/schemas/PublishInfo'

    PublishInfo:
      type: object
      properties:
        is_api_agent:
          type: integer
          description: 是否为API Agent
        is_sdk_agent:
          type: integer
          description: 是否为SDK Agent
        is_skill_agent:
          type: integer
          description: 是否为Skill Agent
        is_data_flow_agent:
          type: integer
          description: 是否为Data Flow Agent

    ConversationListObservabilityReq:
      type: object
      required:
        - agent_id
        - agent_version
      properties:
        agent_id:
          type: string
          description: Agent ID
        agent_version:
          type: string
          description: Agent版本
        title:
          type: string
          description: 对话标题，默认为空查询全部，支持模糊查询
        size:
          type: integer
          description: 分页大小
        limit:
          type: integer
          description: 分页限制

    ConversationListObservabilityResp:
      type: object
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/ConversationDetail'
          description: 对话列表
        total_count:
          type: integer
          description: 总数量

    ConversationDetail:
      type: object
      properties:
        temparea_id:
          type: string
          description: 临时区域ID
        status:
          type: string
          description: 会话最新消息的状态，completed,processing,failed
        # 其他属性继承自Conversation实体

    SessionListObservabilityReq:
      type: object
      required:
        - agent_id
        - agent_version
        - conversation_id
      properties:
        agent_id:
          type: string
          description: Agent ID
        agent_version:
          type: string
          description: Agent版本
        conversation_id:
          type: string
          description: 对话ID
        start:
          type: integer
          format: int64
          description: 开始时间戳
        end:
          type: integer
          format: int64
          description: 结束时间戳
        size:
          type: integer
          description: 分页大小
        limit:
          type: integer
          description: 分页限制

    SessionListObservabilityResp:
      type: object
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/SessionDetailList'
          description: Session详情列表
        total_count:
          type: integer
          description: 不分页情况下的总数量

    SessionDetailObservabilityReq:
      type: object
      required:
        - agent_id
        - agent_version
        - conversation_id
        - session_id
      properties:
        agent_id:
          type: string
          description: Agent ID
        agent_version:
          type: string
          description: Agent版本
        conversation_id:
          type: string
          description: 对话ID
        session_id:
          type: string
          description: Session ID
        start:
          type: integer
          format: int64
          description: 开始时间戳
        end:
          type: integer
          format: int64
          description: 结束时间戳

    SessionDetailObservabilityResp:
      type: object
      properties:
        session_id:
          type: string
          description: Session ID
        start_time:
          type: integer
          format: int64
          description: 开始时间
        end_time:
          type: integer
          format: int64
          description: 结束时间
        session_run_count:
          type: integer
          description: Session运行次数
        session_duration:
          type: integer
          description: Session时长，单位毫秒
        avg_run_execute_duration:
          type: integer
          description: 平均运行执行时长
        avg_run_ttft_duration:
          type: integer
          description: 平均运行首token响应时间
        run_error_count:
          type: integer
          description: 运行错误次数
        tool_fail_count:
          type: integer
          description: 工具失败次数

    SessionDetailList:
      type: object
      properties:
        session_id:
          type: string
          description: Session ID
        start_time:
          type: integer
          format: int64
          description: 开始时间
        end_time:
          type: integer
          format: int64
          description: 结束时间
        session_run_count:
          type: integer
          description: Session运行次数
        session_duration:
          type: integer
          description: Session时长，单位毫秒
        avg_run_execute_duration:
          type: integer
          description: 平均运行执行时长
        avg_run_ttft_duration:
          type: integer
          description: 平均运行首token响应时间
        run_error_count:
          type: integer
          description: 运行错误次数
        tool_fail_count:
          type: integer
          description: 工具失败次数

    RunListObservabilityReq:
      type: object
      required:
        - agent_id
        - agent_version
        - conversation_id
        - session_id
      properties:
        agent_id:
          type: string
          description: Agent ID
        agent_version:
          type: string
          description: Agent版本
        conversation_id:
          type: string
          description: 对话ID
        session_id:
          type: string
          description: Session ID
        start:
          type: integer
          format: int64
          description: 开始时间戳
        end:
          type: integer
          format: int64
          description: 结束时间戳
        limit:
          type: integer
          description: 分页限制
        size:
          type: integer
          description: 分页大小

    RunListObservabilityResp:
      type: object
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/RunDetail'
          description: Run详情列表
        total_count:
          type: integer
          description: 总数量

    RunDetail:
      type: object
      properties:
        run_id:
          type: string
          description: Run ID
        agent_id:
          type: string
          description: Agent ID
        agent_version:
          type: string
          description: Agent版本
        conversation_id:
          type: string
          description: 对话ID
        session_id:
          type: string
          description: 会话ID
        user_id:
          type: string
          description: 用户ID
        call_type:
          type: string
          description: 调用类型 chat/debugchat/apichat
        start_time:
          type: integer
          format: int64
          description: 开始时间，毫秒时间戳
        end:
          type: integer
          format: int64
          description: 结束时间
        ttft:
          type: integer
          description: 首token响应时间，单位ms
        total_time:
          type: integer
          format: int64
          description: 总时间，单位ms
        total_tokens:
          type: integer
          format: int64
          description: 总token数
        input_message:
          type: string
          description: 输入query
        tool_call_count:
          type: integer
          description: 工具调用次数
        tool_call_failed_count:
          type: integer
          description: 工具调用失败次数
        progress:
          type: array
          items:
            type: object
          description: run运行过程
        status:
          type: string
          description: 运行状态 Success / Failed

    RunDetailObservabilityReq:
      type: object
      required:
        - agent_version
        - start_time
        - end_time
      properties:
        agent_version:
          type: string
          description: Agent版本
        start_time:
          type: integer
          format: int64
          description: 开始时间戳，单位精确到毫秒。例如:1646360670123
        end_time:
          type: integer
          format: int64
          description: 结束时间戳，单位精确到毫秒。例如:1646360670123

    RunDetailObservabilityResp:
      type: object
      properties:
        run_id:
          type: string
          description: Run ID
        agent_id:
          type: string
          description: Agent ID
        agent_version:
          type: string
          description: Agent版本
        conversation_id:
          type: string
          description: 对话ID
        session_id:
          type: string
          description: 会话ID
        user_id:
          type: string
          description: 用户ID
        call_type:
          type: string
          description: 调用类型 chat/debugchat/apichat
        start_time:
          type: integer
          format: int64
          description: 开始时间，毫秒时间戳
        end_time:
          type: integer
          format: int64
          description: 结束时间
        ttft:
          type: integer
          description: 首token响应时间，单位ms
        total_time:
          type: integer
          format: int64
          description: 总时间，单位ms
        total_tokens:
          type: integer
          format: int64
          description: 总token数
        input_message:
          type: string
          description: 输入query
        tool_call_count:
          type: integer
          description: 工具调用次数
        tool_call_failed_count:
          type: integer
          description: 工具调用失败次数
        progress:
          type: array
          items:
            type: object
          description: run运行过程
        status:
          type: string
          description: 运行状态 Success / Failed

tags:
  - name: Observability
    description: 可观测性相关接口