# è¡ŒåŠ¨å¬å›åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ å®ç°æ¦‚è¿°

æœ¬æ¬¡å®ç°å®Œæˆäº†**è¡ŒåŠ¨å¬å›åŠŸèƒ½**çš„å®Œæ•´å¼€å‘ï¼Œéµå¾ªé¡¹ç›®çš„åˆ†å±‚æ¶æ„è§„èŒƒï¼ŒåŒ…æ‹¬æ¥å£å®šä¹‰ã€ä¸šåŠ¡é€»è¾‘ã€æœåŠ¡é€‚é…å™¨ç­‰å„å±‚ä»£ç ã€‚

## âœ… å·²å®Œæˆå†…å®¹

### 1. æ¥å£å®šä¹‰å±‚ (interfaces)

**æ–‡ä»¶:** `/server/interfaces/action_recall.go`

å®šä¹‰äº†å®Œæ•´çš„æ•°æ®æ¨¡å‹å’Œæ¥å£ï¼š
- âœ… `ActionRecallRequest` - è¡ŒåŠ¨å¬å›è¯·æ±‚æ¨¡å‹
- âœ… `ActionRecallResponse` - è¡ŒåŠ¨å¬å›å“åº”æ¨¡å‹
- âœ… `DynamicTool` - åŠ¨æ€å·¥å…·å®šä¹‰
- âœ… `FixedParams` - å›ºå®šå‚æ•°ç»“æ„
- âœ… `QueryActionsRequest/Response` - è¡ŒåŠ¨æŸ¥è¯¢ç›¸å…³æ¨¡å‹
- âœ… `GetToolDetailRequest/Response` - å·¥å…·è¯¦æƒ…ç›¸å…³æ¨¡å‹
- âœ… `IActionRecallService` - ä¸šåŠ¡é€»è¾‘æœåŠ¡æ¥å£
- âœ… `DrivenOntologyQueryAction` - è¡ŒåŠ¨æŸ¥è¯¢é€‚é…å™¨æ¥å£
- âœ… `DrivenOperatorToolbox` - å·¥å…·ç®±æœåŠ¡é€‚é…å™¨æ¥å£

### 2. è¢«é©±åŠ¨é€‚é…å™¨å±‚ (drivenadapters)

#### æ–‡ä»¶ 1: `/server/drivenadapters/ontology_query_action.go`
- âœ… å®ç° `DrivenOntologyQueryAction` æ¥å£
- âœ… å°è£…è¡ŒåŠ¨æŸ¥è¯¢æœåŠ¡ï¼ˆontology-queryï¼‰çš„ HTTP è°ƒç”¨
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

#### æ–‡ä»¶ 2: `/server/drivenadapters/operator_toolbox.go`
- âœ… å®ç° `DrivenOperatorToolbox` æ¥å£
- âœ… å°è£…å·¥å…·ç®±æœåŠ¡ï¼ˆagent-operator-integrationï¼‰çš„ HTTP è°ƒç”¨
- âœ… è·å–å·¥å…·è¯¦æƒ…åŠŸèƒ½

### 3. ä¸šåŠ¡é€»è¾‘å±‚ (logics/actionrecall)

#### æ–‡ä»¶ 1: `/server/logics/actionrecall/index.go`
- âœ… æœåŠ¡å®ä¾‹åŒ–å’Œä¾èµ–æ³¨å…¥
- âœ… å•ä¾‹æ¨¡å¼å®ç°

#### æ–‡ä»¶ 2: `/server/logics/actionrecall/get_action_info.go`
- âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ `GetActionInfo` å®ç°
- âœ… å®Œæ•´çš„å¤„ç†æµç¨‹ï¼š
  1. å‚æ•°è½¬æ¢ï¼ˆunique_identity â†’ unique_identitiesï¼‰
  2. è°ƒç”¨è¡ŒåŠ¨æŸ¥è¯¢æ¥å£
  3. æ ¡éªŒ action_source ç±»å‹ï¼ˆä»…æ”¯æŒ toolï¼‰
  4. è·å–å·¥å…·è¯¦æƒ…
  5. ç”Ÿæˆ API URL
  6. æ˜ å°„å›ºå®šå‚æ•°
  7. è½¬æ¢ Schema
  8. æ„å»ºåŠ¨æ€å·¥å…·

#### æ–‡ä»¶ 3: `/server/logics/knactionrecall/schema_converter.go`
- âœ… OpenAPI Schema â†’ OpenAI Function Call Schema è½¬æ¢
- âœ… **åˆ†å±‚ç»“æ„å®ç°**ï¼šä¿æŒ header/path/query/body ä½ç½®ä¿¡æ¯
- âœ… **$ref é€’å½’è§£æ**ï¼šå®Œæ•´æ”¯æŒ OpenAPI $ref å¼•ç”¨
- âœ… **å¾ªç¯å¼•ç”¨é˜²æŠ¤**ï¼šæ£€æµ‹å¹¶é˜²æ­¢æ— é™é€’å½’
- âœ… å›ºå®šå‚æ•°æ˜ å°„é€»è¾‘ï¼ˆæ”¯æŒåŸºäº OpenAPI å®šä¹‰å’Œå‘½åè§„åˆ™ï¼‰

> ğŸ“– **è¯¦ç»†å®ç°åŸç†è¯·å‚è€ƒï¼š** [Schemaè½¬æ¢å®ç°åŸç†.md](./Schemaè½¬æ¢å®ç°åŸç†.md)

### 4. é©±åŠ¨é€‚é…å™¨å±‚ (driveradapters/actionrecall)

**æ–‡ä»¶:** `/server/driveradapters/actionrecall/index.go`
- âœ… HTTP Handler å®ç°
- âœ… è¯·æ±‚å‚æ•°ç»‘å®šå’Œæ ¡éªŒ
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼

### 5. è·¯ç”±æ³¨å†Œ

**æ–‡ä»¶:** `/server/driveradapters/rest_private_handler.go`
- âœ… æ³¨å†Œæ–°è·¯ç”±: `POST /api/agent-retrieval/in/v1/kn/get_action_info`
- âœ… é›†æˆåˆ°ç°æœ‰çš„ç§æœ‰æ¥å£è·¯ç”±ç»„

### 6. é”™è¯¯ç å’Œå›½é™…åŒ–

#### é”™è¯¯ç å®šä¹‰ (`/server/infra/errors/error_code.go`)
- âœ… `ErrExtActionRecallUnsupportedType` - ä¸æ”¯æŒçš„è¡ŒåŠ¨æºç±»å‹
- âœ… `ErrExtActionRecallNoActionsFound` - æœªæ‰¾åˆ°å¯ç”¨è¡ŒåŠ¨
- âœ… `ErrExtActionRecallSchemaConvertFailed` - Schema è½¬æ¢å¤±è´¥
- âœ… `ErrExtActionRecallToolNotFound` - å·¥å…·ä¸å­˜åœ¨

#### å›½é™…åŒ–ç¿»è¯‘
- âœ… ä¸­æ–‡ç¿»è¯‘ (`/server/infra/localize/locales/zh-Hans.json`)
- âœ… è‹±æ–‡ç¿»è¯‘ (`/server/infra/localize/locales/en-US.json`)
- âœ… åŒ…å«é”™è¯¯æè¿°ã€è§£å†³æ–¹æ¡ˆ

## ğŸ¯ å…³é”®è®¾è®¡å†³ç­–

### 1. ä»…å¤„ç† actions[0]
- **åŸå› **: å½“å‰ç‰ˆæœ¬åªæ”¯æŒå•ä¸ª actionï¼Œä½¿ç”¨ `unique_identity`ï¼ˆå•æ•°ï¼‰å…¥å‚
- **å®ç°**: ä»è¡ŒåŠ¨æŸ¥è¯¢å“åº”çš„ actions æ•°ç»„ä¸­åªå–ç¬¬ä¸€ä¸ªå…ƒç´ 

### 2. å¿½ç•¥ dynamic_params
- **åŸå› **: dynamic_params ç”± LLM åŠ¨æ€ç”Ÿæˆï¼Œä¸åœ¨è¡ŒåŠ¨å¬å›æ¥å£çš„å¤„ç†èŒƒå›´å†…
- **å®ç°**: åªå¤„ç† `actions[0].parameters`ï¼ˆå›ºå®šå‚æ•°ï¼‰

### 3. å‚æ•°ä½ç½®æ˜ å°„ç­–ç•¥
- **ä¼˜å…ˆç­–ç•¥**: æ ¹æ® OpenAPI å®šä¹‰ä¸­çš„ `in` å­—æ®µåˆ¤æ–­å‚æ•°ä½ç½®
- **å¤‡ç”¨ç­–ç•¥**: åŸºäºå‘½åè§„åˆ™ï¼ˆå¦‚ x- å¼€å¤´è¯†åˆ«ä¸º headerï¼‰
- **çµæ´»æ€§**: æœ€ç»ˆç”±è°ƒç”¨æ–¹æ ¹æ® `original_schema` å’Œ `fixed_params` ç»„è£…è¯·æ±‚

### 4. ä»…æ”¯æŒ tool ç±»å‹
- **å½“å‰ç‰ˆæœ¬**: åªå¤„ç† `type=tool` çš„è¡ŒåŠ¨æº
- **ä¸‹ä¸ªç‰ˆæœ¬**: é¢„ç•™ MCP ç±»å‹æ”¯æŒçš„æ‰©å±•ç‚¹

## ğŸ“¡ API æ¥å£

### è¯·æ±‚ç¤ºä¾‹

```bash
curl --location 'http://agent-retrieval-svc:8000/api/agent-retrieval/in/v1/kn/get_action_info?kn_id=kn_medical&at_id=generate_treatment_plan' \
--header 'x-account-id: bdb78b62-6c48-11f0-af96-fa8dcc0a06b2' \
--header 'x-account-type: user' \
--header 'Content-Type: application/json' \
--data '{
    "unique_identity": {
        "disease_id": "disease_000001"
    }
}'
```

### å“åº”ç¤ºä¾‹

```json
{
    "_dynamic_tools": [
        {
            "name": "æ ¹æ®å•ä¸ªå¯¹è±¡ç±»æŸ¥è¯¢å¯¹è±¡å®ä¾‹",
            "description": "è¯¥æ¥å£åŸºäºä¸šåŠ¡çŸ¥è¯†ç½‘ç»œè¯­ä¹‰æ£€ç´¢æ¥å£è¿”å›çš„å¯¹è±¡ç±»å®šä¹‰ï¼ŒæŸ¥è¯¢å…·ä½“çš„å¯¹è±¡å®ä¾‹æ•°æ®ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "kn_id": {
                        "type": "string",
                        "description": "ä¸šåŠ¡çŸ¥è¯†ç½‘ç»œID"
                    },
                    "ot_id": {
                        "type": "string",
                        "description": "å¯¹è±¡ç±»ID"
                    }
                },
                "required": ["kn_id", "ot_id"]
            },
            "api_url": "http://agent-operator-integration:9000/api/agent-operator-integration/internal-v1/tool-box/xxx/proxy/yyy",
            "original_schema": {...},
            "fixed_params": {
                "header": {
                    "x-account-id": "test",
                    "x-account-type": "user"
                },
                "path": {},
                "query": {},
                "body": {}
            }
        }
    ]
}
```

## ğŸ“ æ–‡ä»¶æ¸…å•

```
server/
â”œâ”€â”€ interfaces/
â”‚   â””â”€â”€ action_recall.go                    âœ… æ¥å£å®šä¹‰
â”œâ”€â”€ drivenadapters/
â”‚   â”œâ”€â”€ ontology_query_action.go            âœ… è¡ŒåŠ¨æŸ¥è¯¢å®¢æˆ·ç«¯
â”‚   â””â”€â”€ operator_toolbox.go                 âœ… å·¥å…·ç®±å®¢æˆ·ç«¯
â”œâ”€â”€ logics/actionrecall/
â”‚   â”œâ”€â”€ index.go                            âœ… æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ get_action_info.go                  âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ schema_converter.go                 âœ… Schema è½¬æ¢å·¥å…·
â”œâ”€â”€ driveradapters/
â”‚   â”œâ”€â”€ actionrecall/
â”‚   â”‚   â””â”€â”€ index.go                        âœ… HTTP Handler
â”‚   â””â”€â”€ rest_private_handler.go             âœ… è·¯ç”±æ³¨å†Œï¼ˆå·²æ›´æ–°ï¼‰
â””â”€â”€ infra/
    â”œâ”€â”€ errors/
    â”‚   â””â”€â”€ error_code.go                   âœ… é”™è¯¯ç å®šä¹‰ï¼ˆå·²æ›´æ–°ï¼‰
    â””â”€â”€ localize/locales/
        â”œâ”€â”€ zh-Hans.json                    âœ… ä¸­æ–‡ç¿»è¯‘ï¼ˆå·²æ›´æ–°ï¼‰
        â””â”€â”€ en-US.json                      âœ… è‹±æ–‡ç¿»è¯‘ï¼ˆå·²æ›´æ–°ï¼‰
```

## âœ… ç¼–è¯‘éªŒè¯

```bash
cd /root/codes/agent-retrieval
go build ./server/...
```

**ç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. é…ç½®æ–‡ä»¶æ›´æ–°
éœ€è¦ç¡®ä¿é…ç½®æ–‡ä»¶ä¸­åŒ…å«ä»¥ä¸‹é…ç½®ï¼š
- `OntologyQuery` æœåŠ¡åœ°å€ï¼ˆå·²å­˜åœ¨ï¼‰
- `OperatorToolbox` æœåŠ¡åœ°å€ï¼ˆéœ€è¦æ·»åŠ ï¼Œå½“å‰ç¡¬ç¼–ç ä¸º `http://agent-operator-integration:9000`ï¼‰

### 2. ä¾èµ–æœåŠ¡
ç¡®ä¿ä»¥ä¸‹æœåŠ¡å¯ç”¨ï¼š
- ontology-query æœåŠ¡
- agent-operator-integration æœåŠ¡

### 3. å¯åŠ¨æœåŠ¡
```bash
cd /root/codes/agent-retrieval
go run server/main.go
```

## ğŸ”§ TODO å’Œåç»­ä¼˜åŒ–

### MVP ç‰ˆæœ¬å·²å®Œæˆ âœ…
- [x] æ¥å£å®šä¹‰å’Œè·¯ç”±
- [x] å‚æ•°è½¬æ¢ï¼ˆunique_identity â†’ unique_identitiesï¼‰
- [x] è°ƒç”¨è¡ŒåŠ¨æŸ¥è¯¢æ¥å£
- [x] è°ƒç”¨å·¥å…·è¯¦æƒ…æ¥å£ï¼ˆä»… type=toolï¼‰
- [x] ä»…å¤„ç† actions[0]
- [x] ç”Ÿæˆ api_url
- [x] å›ºå®šå‚æ•°æ˜ å°„ï¼ˆåŸºäº OpenAPI å®šä¹‰æˆ–å‘½åè§„åˆ™ï¼‰
- [x] åŸºç¡€çš„ Schema è½¬æ¢ï¼ˆæ‰å¹³åŒ–ï¼Œä¸ä¿ç•™ä½ç½®ä¿¡æ¯ï¼‰
- [x] å¼‚å¸¸å¤„ç†ï¼ˆtype != tool æ—¶è¿”å›é”™è¯¯ï¼‰

### ç¬¬äºŒé˜¶æ®µï¼šSchema è½¬æ¢å¢å¼º ğŸ“‹
- [x] âœ… **$ref é€’å½’è§£æ**ï¼ˆä» components.schemas ä¸­æŸ¥æ‰¾å¹¶å±•å¼€ï¼‰
- [x] âœ… **å¾ªç¯å¼•ç”¨é˜²æŠ¤**ï¼ˆæ£€æµ‹å¹¶é˜²æ­¢æ— é™é€’å½’ï¼‰
- [x] âœ… **åˆ†å±‚ç»“æ„å®ç°**ï¼ˆä¿æŒ header/path/query/body ä½ç½®ä¿¡æ¯ï¼‰
- [ ] å¤æ‚ schema ç±»å‹æ”¯æŒï¼ˆallOf, oneOf, anyOfï¼‰
- [ ] Schema ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤è§£æï¼‰
- [ ] è½¬æ¢è§„åˆ™é…ç½®åŒ–ï¼ˆæ”¯æŒè‡ªå®šä¹‰æ˜ å°„è§„åˆ™ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šæ‰©å±•æ”¯æŒ ğŸ“‹
- [ ] MCP ç±»å‹è¡ŒåŠ¨æºæ”¯æŒ
- [ ] å¤šä¸ª actions çš„å¤„ç†ç­–ç•¥
- [ ] è¡ŒåŠ¨å¬å›ç»“æœç¼“å­˜
- [ ] å¯è§‚æµ‹æ€§å¢å¼ºï¼ˆæ—¥å¿—ã€ç›‘æ§ã€è¿½è¸ªï¼‰
- [ ] æ”¯æŒè¡ŒåŠ¨çš„æ¡ä»¶åŒ¹é…

## ğŸ“– å‚è€ƒæ–‡æ¡£

- [éœ€æ±‚è®¾è®¡æ–‡æ¡£](./éœ€æ±‚è®¾è®¡æ–‡æ¡£.md)
- [Schemaè½¬æ¢å®ç°åŸç†](./Schemaè½¬æ¢å®ç°åŸç†.md) â­ **æ–°å¢ï¼šè¯¦ç»†å®ç°åŸç†è¯´æ˜**
- [OpenAPI æ¥å£æ–‡æ¡£](./action-recall.openapi.yaml)
- [åŸå§‹éœ€æ±‚](./01-éœ€æ±‚.md)
- [ä¾èµ–æ¥å£æ–‡æ¡£](./99-ä¾èµ–æ¥å£/)

## ğŸ‘¥ å¼€å‘å›¢é˜Ÿ

- å¼€å‘å®Œæˆæ—¶é—´: 2025-12-23
- éµå¾ªè§„èŒƒ: é¡¹ç›®åˆ†å±‚æ¶æ„ã€Go ç¼–ç è§„èŒƒ
- æµ‹è¯•çŠ¶æ€: ç¼–è¯‘é€šè¿‡ï¼Œå¾…é›†æˆæµ‹è¯•

---

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ MVP ç‰ˆæœ¬
**ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæ•´

