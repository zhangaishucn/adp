# KnowledgeRerank 模块逻辑设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| **功能名称** | KnowledgeRerank（知识重排序） |
| **文档版本** | v1.0 |
| **状态** | 已实现 |

---

## 1. 功能定位

KnowledgeRerank 是一个**内部复用模块**，不对外提供独立 API。对输入的候选概念列表进行相关性排序，过滤掉与问题无关的概念。

### 1.1 调用方

| 调用方 | 调用场景 | 对应 API |
|--------|----------|----------|
| **KnRetrieval** | 概念重排序 | `POST /kn/semantic-search` |

**说明**：KnowledgeRerank **不被 KnSearch 调用**。KnSearch 的关系类型排序直接使用 MF Model API Rerank，不经过本模块。

---

## 2. 功能说明

KnowledgeRerank 提供对概念列表的精细化排序能力，支持两种模式：

| 模式 | 适用场景 | 评分特点 |
|------|----------|----------|
| **LLM 模式**（默认） | 概念筛选、Schema 精排 | 二值化评分 (0/1) |
| **Vector 模式** | 相似度排序 | 连续分数 (0.0~1.0) |

---

## 3. 业务流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         KnowledgeRerank 重排序流程                           │
└─────────────────────────────────────────────────────────────────────────────┘

                          ┌───────────────────┐
                          │    重排序请求      │
                          │ Query + Concepts  │
                          └─────────┬─────────┘
                                    │
                                    ▼
                          ┌───────────────────┐
                          │   检查概念列表     │
                          │   是否为空?        │
                          └─────────┬─────────┘
                                    │
                        ┌───────────┴───────────┐
                        │                       │
                      为空                    不为空
                        │                       │
                        ▼                       ▼
             ┌──────────────────┐    ┌──────────────────┐
             │   返回空列表     │    │  检查 Action 类型 │
             └──────────────────┘    └─────────┬────────┘
                                               │
                                   ┌───────────┴───────────┐
                                   │                       │
                             action="vector"         action="llm" (默认)
                                   │                       │
                                   ▼                       ▼
                   ┌───────────────────────┐   ┌───────────────────────┐
                   │    Vector Rerank      │   │      LLM Rerank       │
                   │                       │   │                       │
                   │ 1. 格式化概念为文本    │   │ 1. 计算批次数量        │
                   │ 2. 调用 Rerank API    │   │    (batchSize=128)    │
                   │ 3. 获取相关性分数      │   │                       │
                   │ 4. 按分数排序         │   │ 2. 循环处理每个批次    │
                   │                       │   │    ├─ 构建 Prompt     │
                   └───────────┬───────────┘   │    ├─ 调用 LLM Chat   │
                               │               │    └─ 解析索引列表     │
                               │               │                       │
                               │               │ 3. 合并去重索引        │
                               │               │                       │
                               │               │ 4. 二值化评分          │
                               │               │    选中=1.0, 未选=0.0  │
                               │               │                       │
                               │               │ 5. 按评分排序          │
                               │               └───────────┬───────────┘
                               │                           │
                               └─────────────┬─────────────┘
                                             │
                                             ▼
                                 ┌───────────────────────┐
                                 │   返回排序后的概念列表  │
                                 │  (含 RerankScore 字段) │
                                 └───────────────────────┘
```

---

## 4. 核心逻辑详解

### 4.1 LLM 模式（默认）

**Prompt 构建策略**：

```
{{if .Intent}}用户的意图是：{{.Intent}}
{{end}}问题: {{.Question}}
请仔细分析以下概念列表，只返回与上述问题相关的概念编号。
对于与问题无关的概念，请完全忽略，不要在输出中包含它们。
请按照与问题相关性从高到低的顺序返回概念编号。
概念列表:
[1] 我们有一个'客户'的概念，描述为企业客户信息，具有客户名称，联系方式。
[2] 我们有一个'产品'的概念，描述为产品信息表。
[3] 我们有一个'日志'的概念，描述为系统操作日志。
请只返回与问题相关的概念编号，按照相关性排序，以列表形式返回，例如：[3, 1, 5]，都不相关，返回[]
```

**分批处理（Batching）**：
- 批次大小：128
- 避免单次请求 Token 超限
- 各批次独立处理，失败不影响其他批次

**评分逻辑**：
- LLM 返回的索引 → Score = 1.0（相关）
- 未返回的索引 → Score = 0.0（不相关）
- 最终按 Score 降序排列，相关概念排在前面

**索引解析**：
- 优先匹配 JSON 数组：`\[([0-9,\s]+)\]` → `[1, 3, 5]`
- 降级匹配所有数字：`\d+` → `1, 3, 5`

### 4.2 Vector 模式

**处理流程**：

1. **概念文本化**：将每个概念转换为描述文本
   ```
   "我们有一个'客户'的概念，描述为企业客户信息，具有客户名称，联系方式。"
   ```

2. **调用 Rerank 服务**：
   ```json
   {
     "query": "用户问题",
     "documents": ["概念1文本", "概念2文本", ...],
     "model": "reranker"
   }
   ```

3. **评分映射**：直接使用返回的 `relevance_score`（0.0 ~ 1.0）

4. **排序返回**：按分数降序排列

---

## 5. 异常处理策略

| 异常场景 | 处理方式 |
|----------|----------|
| 概念列表为空 | 直接返回空列表 |
| LLM 批次调用失败 | 跳过该批次，继续处理其他批次 |
| LLM 解析失败 | 该批次概念得分为 0.0 |
| Vector 服务超时 | 降级返回原顺序，所有概念得分为 0.0 |
| 概念格式化失败 | 降级使用概念名称作为文本 |

---

## 6. 参考文档

- [KnowledgeRerank模块实现设计.md](./KnowledgeRerank模块实现设计.md)
