{
    "openapi": "3.0.3",
    "info": {
        "title": "业务知识网络检索工具箱",
        "description": "支持对业务知识网络进行处理的工具箱，工具包含: kn_search",
        "version": "1.0.11"
    },
    "servers": [
        {
            "url": "http://data-retrieval:9100"
        }
    ],
    "paths": {
        "/tools/kn_search": {
            "post": {
                "summary": "kn_search",
                "description": "基于知识网络的智能检索工具，支持传入完整的问题或一个或多个关键词，能够检索问题或关键词的属性信息和上下文信息。",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "query": {
                                        "type": "string",
                                        "description": "用户查询问题或关键词，多个关键词之间用空格隔开"
                                    },
                                    "kn_ids": {
                                        "type": "array",
                                        "items": {
                                            "type": "object",
                                            "properties": {
                                                "knowledge_network_id": {
                                                    "type": "string",
                                                    "description": "知识网络ID"
                                                }
                                            },
                                            "required": [
                                                "knowledge_network_id"
                                            ]
                                        },
                                        "description": "指定的知识网络配置列表，必须传递，每个配置包含knowledge_network_id字段"
                                    },
                                    "session_id": {
                                        "type": "string",
                                        "description": "会话ID，用于维护多轮对话存储的历史召回记录",
                                        "nullable": true
                                    },
                                    "additional_context": {
                                        "type": "string",
                                        "description": "额外的上下文信息，用于二次检索时提供更精确的检索信息",
                                        "nullable": true
                                    },
                                    "retrieval_config": {
                                        "type": "object",
                                        "description": "召回配置参数，用于控制不同类型的召回场景（概念召回、语义实例召回、属性过滤）。如果不提供，将使用系统默认配置。",
                                        "nullable": true,
                                        "properties": {
                                            "concept_retrieval": {
                                                "type": "object",
                                                "description": "概念召回/概念流程配置参数（原最外层参数已收敛到此处）",
                                                "nullable": true,
                                                "properties": {
                                                    "top_k": {
                                                        "type": "integer",
                                                        "description": "概念召回返回最相关关系类型数量（对象类型会随关系类型自动过滤）。",
                                                        "minimum": 1,
                                                        "default": 10
                                                    },
                                                    "skip_llm": {
                                                        "type": "boolean",
                                                        "description": "是否跳过LLM筛选相关关系类型，直接使用前top_k个关系类型（高召回/低成本）。",
                                                        "default": true
                                                    },
                                                    "return_union": {
                                                        "type": "boolean",
                                                        "description": "概念召回多轮检索时是否返回并集。True返回所有轮次并集；False仅返回当前轮次增量（默认False）。",
                                                        "default": false
                                                    },
                                                    "include_sample_data": {
                                                        "type": "boolean",
                                                        "description": "是否获取对象类型的样例数据。True会为每个召回对象类型获取一条样例数据。",
                                                        "default": false
                                                    },
                                                    "schema_brief": {
                                                        "type": "boolean",
                                                        "description": "概念召回时是否返回精简schema。True仅返回必要字段（概念ID/名称/关系source&target），不返回大字段。",
                                                        "default": true
                                                    },
                                                    "enable_coarse_recall": {
                                                        "type": "boolean",
                                                        "description": "是否在概念召回前启用对象/关系粗召回，用于在大规模知识网络中先裁剪候选集合。",
                                                        "default": true
                                                    },
                                                    "coarse_object_limit": {
                                                        "type": "integer",
                                                        "description": "对象类型粗召回的最大返回数量，用于限制候选对象规模。",
                                                        "minimum": 1,
                                                        "default": 2000
                                                    },
                                                    "coarse_relation_limit": {
                                                        "type": "integer",
                                                        "description": "关系类型粗召回的最大返回数量，用于限制候选关系规模。",
                                                        "minimum": 1,
                                                        "default": 300
                                                    },
                                                    "coarse_min_relation_count": {
                                                        "type": "integer",
                                                        "description": "仅当知识网络内关系类型总数达到该阈值时才启用粗召回；小规模网络直接走精排流程。",
                                                        "minimum": 1,
                                                        "default": 5000
                                                    },
                                                    "enable_property_brief": {
                                                        "type": "boolean",
                                                        "description": "在 schema_brief=True 时，是否对返回的对象属性做相关性裁剪（每对象TopK，全局TopK）。",
                                                        "default": true
                                                    },
                                                    "per_object_property_top_k": {
                                                        "type": "integer",
                                                        "description": "属性裁剪时，每个对象类型最多保留的属性数量。生产环境建议值：8-10，适配表多、字段多的场景。",
                                                        "minimum": 1,
                                                        "default": 8
                                                    },
                                                    "global_property_top_k": {
                                                        "type": "integer",
                                                        "description": "属性裁剪时，全局最多保留的属性总数量。生产环境建议值：30-50，确保在多对象类型场景下保留足够的全局属性信息。",
                                                        "minimum": 1,
                                                        "default": 30
                                                    }
                                                }
                                            },
                                            "semantic_instance_retrieval": {
                                                "type": "object",
                                                "description": "语义实例召回配置参数",
                                                "nullable": true,
                                                "properties": {
                                                    "initial_candidate_count": {
                                                        "type": "integer",
                                                        "description": "语义实例召回的初始召回数量上限（重排序前的候选数量）。建议值：一般设置为per_type_instance_limit的3-5倍。",
                                                        "minimum": 1,
                                                        "default": 50
                                                    },
                                                    "per_type_instance_limit": {
                                                        "type": "integer",
                                                        "description": "每个对象类型最终返回的实例数量上限（重排序后的数量）。每个对象类型单独控制。",
                                                        "minimum": 1,
                                                        "default": 5
                                                    },
                                                    "max_semantic_sub_conditions": {
                                                        "type": "integer",
                                                        "description": "语义实例召回构造查询条件时 sub_conditions 的最大数量上限（用于适配后端限制与控成本）。默认10。",
                                                        "minimum": 1,
                                                        "default": 10
                                                    },
                                                    "semantic_field_keep_ratio": {
                                                        "type": "number",
                                                        "description": "语义字段筛选保留比例（按重排序分数Top-K保留）。例如0.2表示保留前20%的字段。",
                                                        "minimum": 0.01,
                                                        "maximum": 1.0,
                                                        "default": 0.2
                                                    },
                                                    "semantic_field_keep_min": {
                                                        "type": "integer",
                                                        "description": "语义字段筛选最少保留字段数（字段较少时兜底）。",
                                                        "minimum": 1,
                                                        "default": 5
                                                    },
                                                    "semantic_field_keep_max": {
                                                        "type": "integer",
                                                        "description": "语义字段筛选最多保留字段数（字段很多时强力限流）。",
                                                        "minimum": 1,
                                                        "default": 15
                                                    },
                                                    "semantic_field_rerank_batch_size": {
                                                        "type": "integer",
                                                        "description": "字段语义打分（rerank）时的批处理大小，字段数很大时会分批调用重排序服务。",
                                                        "minimum": 1,
                                                        "default": 128
                                                    },
                                                    "min_direct_relevance": {
                                                        "type": "number",
                                                        "description": "直接相关性最低阈值（0-1之间）。过滤掉直接相关性分数低于此阈值的实例。",
                                                        "minimum": 0.0,
                                                        "maximum": 1.0,
                                                        "default": 0.3
                                                    },
                                                    "enable_global_final_score_ratio_filter": {
                                                        "type": "boolean",
                                                        "description": "是否启用全局 final_score 相对阈值过滤。启用后仅保留 final_score >= max_final_score * global_final_score_ratio 的实例。",
                                                        "default": true
                                                    },
                                                    "global_final_score_ratio": {
                                                        "type": "number",
                                                        "description": "全局 final_score 相对阈值比例 r（0~1）。当 enable_global_final_score_ratio_filter=True 时，仅保留 final_score >= max_final_score * r 的实例。",
                                                        "minimum": 0.0,
                                                        "maximum": 1.0,
                                                        "default": 0.25
                                                    },
                                                    "exact_name_match_score": {
                                                        "type": "number",
                                                        "description": "多关键词检索场景下的实例名完全相等保底分（0~1）。当 query 被拆分为多个关键词时，只要任一关键词与 instance_name 完全相等，则会将该实例的基础语义分提升到该值，避免被其他关键词（如症状词）稀释后丢失。",
                                                        "minimum": 0.0,
                                                        "maximum": 1.0,
                                                        "default": 0.85
                                                    }
                                                }
                                            },
                                            "property_filter": {
                                                "type": "object",
                                                "description": "实例属性过滤配置（通用，适用于所有实例召回）",
                                                "nullable": true,
                                                "properties": {
                                                    "max_properties_per_instance": {
                                                        "type": "integer",
                                                        "description": "每个实例最多返回的属性字段数量。用于过滤实例属性，减少返回结果大小。",
                                                        "minimum": 1,
                                                        "default": 20
                                                    },
                                                    "max_property_value_length": {
                                                        "type": "integer",
                                                        "description": "属性值的最大长度（字符数），超过此长度的字段值会被过滤。",
                                                        "minimum": 1,
                                                        "default": 500
                                                    },
                                                    "enable_property_filter": {
                                                        "type": "boolean",
                                                        "description": "是否启用实例属性过滤。如果为False，返回所有属性字段。",
                                                        "default": true
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    "only_schema": {
                                        "type": "boolean",
                                        "description": "是否只召回概念（schema），不召回语义实例。如果为True，则只返回object_types、relation_types和action_types，不返回nodes。默认为False。",
                                        "default": false
                                    }
                                },
                                "required": [
                                    "query",
                                    "kn_ids"
                                ]
                            },
                            "examples": {
                            }
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "x-account-id",
                        "in": "header",
                        "required": false,
                        "schema": {
                            "type": "string"
                        },
                        "description": "账户ID，用于内部服务调用时传递账户信息"
                    },
                    {
                        "name": "x-account-type",
                        "in": "header",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "user",
                                "app",
                                "anonymous"
                            ],
                            "default": "user"
                        },
                        "description": "账户类型：user(用户), app(应用), anonymous(匿名)"
                    },
                    {
                        "name": "Content-Type",
                        "in": "header",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "default": "application/json"
                        },
                        "description": "内容类型"
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Successful operation",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "description": "检索结果，返回object_types/relation_types/action_types，并返回语义实例nodes/message。多轮时由concept_retrieval.return_union控制 nodes 的并集/增量。",
                                    "properties": {
                                        "object_types": {
                                            "type": "array",
                                            "description": "对象类型列表（概念召回时返回）。当schema_brief=True时，仅包含：concept_id, concept_name, comment, data_properties（仅name和display_name）, logic_properties（仅name和display_name）, sample_data（当include_sample_data=True时）。当schema_brief=False时，包含完整字段（包括primary_keys, display_key, sample_data等）",
                                            "items": {
                                                "type": "object",
                                                "properties": {
                                                    "concept_type": {
                                                        "type": "string",
                                                        "description": "概念类型: object_type",
                                                        "nullable": true
                                                    },
                                                    "concept_id": {
                                                        "type": "string",
                                                        "description": "概念ID"
                                                    },
                                                    "concept_name": {
                                                        "type": "string",
                                                        "description": "概念名称"
                                                    },
                                                    "comment": {
                                                        "type": "string",
                                                        "description": "概念描述",
                                                        "nullable": true
                                                    },
                                                    "data_properties": {
                                                        "type": "array",
                                                        "description": "对象属性列表。精简模式下仅包含name和display_name字段（数量不截断）",
                                                        "items": {
                                                            "type": "object",
                                                            "description": "对象属性",
                                                            "properties": {
                                                                "name": {
                                                                    "type": "string",
                                                                    "description": "属性名称",
                                                                    "nullable": true
                                                                },
                                                                "display_name": {
                                                                    "type": "string",
                                                                    "description": "属性显示名称",
                                                                    "nullable": true
                                                                },
                                                                "comment": {
                                                                    "type": "string",
                                                                    "description": "属性描述（非精简模式）",
                                                                    "nullable": true
                                                                }
                                                            }
                                                        },
                                                        "nullable": true
                                                    },
                                                    "logic_properties": {
                                                        "type": "array",
                                                        "description": "逻辑属性列表（指标等）。精简模式下仅包含name和display_name字段（数量不截断）",
                                                        "items": {
                                                            "type": "object",
                                                            "description": "逻辑属性",
                                                            "properties": {
                                                                "name": {
                                                                    "type": "string",
                                                                    "description": "属性名称",
                                                                    "nullable": true
                                                                },
                                                                "display_name": {
                                                                    "type": "string",
                                                                    "description": "属性显示名称",
                                                                    "nullable": true
                                                                }
                                                            }
                                                        },
                                                        "nullable": true
                                                    },
                                                    "primary_keys": {
                                                        "type": "array",
                                                        "description": "主键字段列表（支持多个主键）。仅当schema_brief=False时返回",
                                                        "items": {
                                                            "type": "string"
                                                        },
                                                        "nullable": true
                                                    },
                                                    "display_key": {
                                                        "type": "string",
                                                        "description": "显示字段名（用于获取instance_name）。仅当schema_brief=False时返回",
                                                        "nullable": true
                                                    },
                                                    "sample_data": {
                                                        "type": "object",
                                                        "description": "样例数据（当include_sample_data=True时返回，无论schema_brief是否为True）",
                                                        "nullable": true
                                                    }
                                                },
                                                "required": [
                                                    "concept_id",
                                                    "concept_name"
                                                ]
                                            }
                                        },
                                        "relation_types": {
                                            "type": "array",
                                            "description": "关系类型列表（概念召回时返回）。精简模式和完整模式均包含：concept_id, concept_name, source_object_type_id, target_object_type_id",
                                            "items": {
                                                "type": "object",
                                                "properties": {
                                                    "concept_type": {
                                                        "type": "string",
                                                        "description": "概念类型: relation_type",
                                                        "nullable": true
                                                    },
                                                    "concept_id": {
                                                        "type": "string",
                                                        "description": "概念ID"
                                                    },
                                                    "concept_name": {
                                                        "type": "string",
                                                        "description": "概念名称"
                                                    },
                                                    "source_object_type_id": {
                                                        "type": "string",
                                                        "description": "源对象类型ID"
                                                    },
                                                    "target_object_type_id": {
                                                        "type": "string",
                                                        "description": "目标对象类型ID"
                                                    }
                                                },
                                                "required": [
                                                    "concept_id",
                                                    "concept_name",
                                                    "source_object_type_id",
                                                    "target_object_type_id"
                                                ]
                                            }
                                        },
                                        "action_types": {
                                            "type": "array",
                                            "description": "操作类型列表（概念召回时返回）。当schema_brief=True时，每个action_type仅包含以下字段：id, name, action_type, object_type_id, object_type_name, comment, tags, kn_id",
                                            "nullable": true,
                                            "items": {
                                                "type": "object",
                                                "description": "操作类型信息。精简模式（schema_brief=True）下仅包含：id, name, action_type, object_type_id, object_type_name, comment, tags, kn_id",
                                                "properties": {
                                                    "id": {
                                                        "type": "string",
                                                        "description": "操作类型ID"
                                                    },
                                                    "name": {
                                                        "type": "string",
                                                        "description": "操作类型名称"
                                                    },
                                                    "action_type": {
                                                        "type": "string",
                                                        "description": "操作类型（如：add, modify等）"
                                                    },
                                                    "object_type_id": {
                                                        "type": "string",
                                                        "description": "对象类型ID"
                                                    },
                                                    "object_type_name": {
                                                        "type": "string",
                                                        "description": "对象类型名称"
                                                    },
                                                    "comment": {
                                                        "type": "string",
                                                        "description": "注释说明",
                                                        "nullable": true
                                                    },
                                                    "tags": {
                                                        "type": "array",
                                                        "description": "标签列表",
                                                        "items": {
                                                            "type": "string"
                                                        },
                                                        "nullable": true
                                                    },
                                                    "kn_id": {
                                                        "type": "string",
                                                        "description": "知识网络ID"
                                                    }
                                                }
                                            }
                                        },
                                        "nodes": {
                                            "type": "array",
                                            "description": "语义实例召回结果（当不提供conditions且召回到实例时返回），与条件召回节点风格对齐的扁平列表",
                                            "nullable": true,
                                            "items": {
                                                "type": "object",
                                                "description": "节点数据，至少包含 object_type_id、<object_type_id>_name、unique_identities",
                                                "properties": {
                                                    "object_type_id": {
                                                        "type": "string"
                                                    },
                                                    "unique_identities": {
                                                        "type": "object"
                                                    }
                                                }
                                            }
                                        },
                                        "message": {
                                            "type": "string",
                                            "description": "提示信息（例如未召回到实例数据时返回原因说明）",
                                            "nullable": true
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}