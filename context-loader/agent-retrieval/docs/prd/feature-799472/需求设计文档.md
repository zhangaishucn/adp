# è¡ŒåŠ¨å¬å›åŠŸèƒ½éœ€æ±‚è®¾è®¡æ–‡æ¡£

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä½
è¡ŒåŠ¨å¬å›åŠŸèƒ½æ˜¯å¯¹ç°æœ‰"è¡ŒåŠ¨æŸ¥è¯¢æ¥å£"çš„å°è£…å’Œå¢å¼ºï¼Œæ—¨åœ¨ä¸º Agent ç³»ç»Ÿæä¾›åŠ¨æ€å·¥å…·å‘ç°å’Œè°ƒç”¨èƒ½åŠ›ã€‚é€šè¿‡è¯­ä¹‰åŒ–çš„å¯¹è±¡æ ‡è¯†ï¼Œè‡ªåŠ¨æ£€ç´¢ç›¸å…³çš„è¡ŒåŠ¨ï¼Œå¹¶å°†è¿™äº›è¡ŒåŠ¨è½¬æ¢ä¸ºç¬¦åˆ OpenAI Function Call è§„èŒƒçš„å·¥å…·å®šä¹‰ã€‚

### 1.2 åº”ç”¨åœºæ™¯
- Agent æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ä¸­è¯†åˆ«åˆ°çš„å®ä½“å¯¹è±¡ï¼ŒåŠ¨æ€è·å–å¯æ‰§è¡Œçš„è¡ŒåŠ¨å·¥å…·
- å®ç°"æ‰€è§å³å¯ä¸º"çš„æ™ºèƒ½äº¤äº’ä½“éªŒï¼šå½“ Agent è·å–åˆ°æŸä¸ªå¯¹è±¡ä¿¡æ¯åï¼Œè‡ªåŠ¨è·å–é’ˆå¯¹è¯¥å¯¹è±¡çš„å¯ç”¨æ“ä½œ
- æ”¯æŒçŸ¥è¯†ç½‘ç»œä¸è¡ŒåŠ¨èƒ½åŠ›çš„åŠ¨æ€ç»‘å®š

### 1.3 æ ¸å¿ƒä»·å€¼
- **åŠ¨æ€æ€§**ï¼šè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡å®ä¾‹åŠ¨æ€å‘ç°å¯ç”¨å·¥å…·ï¼Œæ— éœ€é¢„å…ˆæ³¨å†Œ
- **è¯­ä¹‰åŒ–**ï¼šåŸºäºå¯¹è±¡çš„è¯­ä¹‰æ ‡è¯†è¿›è¡Œè¡ŒåŠ¨å¬å›ï¼Œè€Œéç¡¬ç¼–ç çš„å·¥å…·åˆ—è¡¨
- **æ ‡å‡†åŒ–**ï¼šè¾“å‡ºç¬¦åˆ OpenAI Function Call æ ‡å‡†çš„å·¥å…·å®šä¹‰ï¼Œä¾¿äº LLM è°ƒç”¨

---

## äºŒã€æŠ€æœ¯æ¶æ„

### 2.1 ä¾èµ–æœåŠ¡

| æœåŠ¡åç§° | æ¥å£ | ç”¨é€” |
|---------|------|------|
| ontology-query | `/api/ontology-query/v1/knowledge-networks/{kn_id}/action-types/{at_id}` | è¡ŒåŠ¨æŸ¥è¯¢ï¼šæ ¹æ®å¯¹è±¡å”¯ä¸€æ ‡è¯†æŸ¥è¯¢å¯æ‰§è¡Œçš„è¡ŒåŠ¨åˆ—è¡¨ |
| agent-operator-integration | `/api/agent-operator-integration/internal-v1/tool-box/{box_id}/tool/{tool_id}` | å·¥å…·è¯¦æƒ…æŸ¥è¯¢ï¼šè·å–å·¥å…·çš„å®Œæ•´ OpenAPI å®šä¹‰ |
| agent-operator-integration | `/api/agent-operator-integration/internal-v1/tool-box/{box_id}/proxy/{tool_id}` | å·¥å…·æ‰§è¡Œä»£ç†ï¼šå®é™…æ‰§è¡Œå·¥å…·è°ƒç”¨çš„ç»Ÿä¸€å…¥å£ |

### 2.2 æœåŠ¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è°ƒç”¨æ–¹     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. å‘èµ·å¬å›è¯·æ±‚ï¼ˆå•ä¸ª unique_identityï¼‰
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡ŒåŠ¨å¬å›æ¥å£ï¼ˆæ–°ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. åŒ…è£…ä¸ºæ•°ç»„è°ƒç”¨
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡ŒåŠ¨æŸ¥è¯¢æ¥å£         â”‚  (ontology-query)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. è¿”å› actions + action_source
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ¤æ–­ action_source  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. å¦‚æœ type=tool
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·å–å·¥å…·è¯¦æƒ…æ¥å£     â”‚  (agent-operator-integration)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. è¿”å›å·¥å…·çš„ OpenAPI å®šä¹‰
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ¼å¼è½¬æ¢å¤„ç†        â”‚
â”‚  - OpenAPI â†’ OpenAI â”‚
â”‚  - å‚æ•°æ˜ å°„          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. è¿”å› _dynamic_tools
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è°ƒç”¨æ–¹     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å…³é”®è®¾è®¡å†³ç­–

#### 2.3.1 ä¸ºä»€ä¹ˆåªå¤„ç† actions[0]ï¼Ÿ

**è®¾è®¡åŸå› ï¼š**
- å½“å‰ç‰ˆæœ¬çš„è¾“å…¥æ˜¯ `unique_identity`ï¼ˆå•æ•°ï¼‰ï¼Œè¡¨ç¤ºé’ˆå¯¹å•ä¸ªå¯¹è±¡å®ä¾‹è¿›è¡Œè¡ŒåŠ¨å¬å›
- ä¸€ä¸ªå¯¹è±¡çš„ä¸€ä¸ªè¡ŒåŠ¨ç±»å‹ï¼ˆaction_typeï¼‰ï¼Œé€šå¸¸å¯¹åº”ä¸€ä¸ªå…·ä½“çš„å·¥å…·å®ç°
- actions æ•°ç»„çš„å¤šä¸ªå…ƒç´ ï¼Œé€šå¸¸æ˜¯åŒä¸€è¡ŒåŠ¨é’ˆå¯¹ä¸åŒå¯¹è±¡å®ä¾‹çš„å‚æ•°å®ä¾‹åŒ–ç»“æœ
- ç”±äºåªä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤åªéœ€è¦å¤„ç†ç¬¬ä¸€ä¸ª action å³å¯

**åç»­æ‰©å±•æ–¹å‘ï¼š**
- ä¸‹ä¸ªç‰ˆæœ¬å¯æ”¯æŒ `unique_identities`ï¼ˆå¤æ•°ï¼‰ï¼Œè¿”å›å¤šä¸ªå·¥å…·å®šä¹‰

#### 2.3.2 ä¸ºä»€ä¹ˆä¸å¤„ç† dynamic_paramsï¼Ÿ

**è®¾è®¡åŸå› ï¼š**
- `dynamic_params` è¡¨ç¤ºéœ€è¦ç”±å¤§æ¨¡å‹æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€ç”Ÿæˆçš„å‚æ•°
- è¿™äº›å‚æ•°çš„å€¼ä¸º `null`ï¼Œè¡¨ç¤ºå°šæœªå®ä¾‹åŒ–ï¼Œéœ€è¦ LLM æ¨ç†
- è¡ŒåŠ¨å¬å›æ¥å£çš„èŒè´£æ˜¯"å‘Šè¯‰ LLM æœ‰å“ªäº›å·¥å…·å¯ç”¨"ï¼Œè€Œä¸æ˜¯"æ›¿ LLM ç”Ÿæˆå‚æ•°"

**åˆ†å·¥æ˜ç¡®ï¼š**
- **è¡ŒåŠ¨å¬å›æ¥å£**ï¼šæä¾›å·¥å…·å®šä¹‰ï¼ˆname, description, parameters schemaï¼‰å’Œå›ºå®šå‚æ•°ï¼ˆfixed_paramsï¼‰
- **LLM**ï¼šæ ¹æ®å·¥å…·å®šä¹‰å’Œä¸Šä¸‹æ–‡ï¼ŒåŠ¨æ€ç”Ÿæˆå‚æ•°å€¼
- **è°ƒç”¨æ–¹**ï¼šåˆå¹¶ fixed_params å’Œ LLM ç”Ÿæˆçš„å‚æ•°ï¼Œç»„è£…å®é™…è¯·æ±‚

#### 2.3.3 ä¸ºä»€ä¹ˆå‚æ•°ä½ç½®åˆ¤æ–­äº¤ç»™è°ƒç”¨æ–¹ï¼Ÿ

**è®¾è®¡åŸå› ï¼š**
- è¡ŒåŠ¨å¬å›æ¥å£ä¸“æ³¨äº"å·¥å…·å‘ç°"ï¼Œè€Œé"å·¥å…·è°ƒç”¨"
- ä¸åŒçš„è°ƒç”¨æ–¹å¯èƒ½æœ‰ä¸åŒçš„å‚æ•°ç»„è£…ç­–ç•¥
- é€šè¿‡è¿”å› `original_schema` å’Œ `fixed_params`ï¼Œç»™è°ƒç”¨æ–¹æœ€å¤§çš„çµæ´»æ€§

**èŒè´£è¾¹ç•Œï¼š**
- **è¡ŒåŠ¨å¬å›æ¥å£**ï¼šè¿”å›å·¥å…·å…ƒæ•°æ®ï¼ˆschema + å›ºå®šå‚æ•°ï¼‰
- **è°ƒç”¨æ–¹/ä¸­é—´å±‚**ï¼šæ ¹æ®å…ƒæ•°æ®ç»„è£…å®é™…çš„ HTTP è¯·æ±‚
- è¿™æ ·è®¾è®¡ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

#### 2.3.4 ä¸ºä»€ä¹ˆ Schema ä¸ä¿ç•™ä½ç½®ä¿¡æ¯ï¼Ÿ

**è®¾è®¡åŸå› ï¼š**
- OpenAI Function Call çš„ parameters schema ä¸éœ€è¦ä½ç½®ä¿¡æ¯
- LLM åªéœ€è¦çŸ¥é“"æœ‰å“ªäº›å‚æ•°ã€ç±»å‹æ˜¯ä»€ä¹ˆã€æè¿°æ˜¯ä»€ä¹ˆ"ï¼Œä¸éœ€è¦çŸ¥é“å‚æ•°æ¥è‡ª path/query/header/body
- å‚æ•°ä½ç½®ä¿¡æ¯å·²ç»åŒ…å«åœ¨ `original_schema` ä¸­ï¼Œè°ƒç”¨æ–¹å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨

**ç®€åŒ–è®¾è®¡ï¼š**
- æ‰å¹³åŒ–çš„ parameters schema æ›´ç¬¦åˆ OpenAI è§„èŒƒ
- é™ä½äº† LLM ç†è§£çš„å¤æ‚åº¦
- ä¿æŒäº†æ¥å£çš„ç®€æ´æ€§

---

## ä¸‰ã€æ¥å£è®¾è®¡

### 3.1 è¡ŒåŠ¨å¬å›æ¥å£ï¼ˆæ–°å»ºï¼‰

#### 3.1.1 æ¥å£å®šä¹‰

```
POST /api/agent-retrieval/in/v1/kn/get_action_info
```

#### 3.1.2 è¯·æ±‚å‚æ•°

**Path Parameters:**
- `kn_id` (string, required): ä¸šåŠ¡çŸ¥è¯†ç½‘ç»œ ID
- `at_id` (string, required): è¡ŒåŠ¨ç±»å‹ ID

**Headers:**
- `x-account-id` (string, required): è´¦æˆ· ID
- `x-account-type` (string, required): è´¦æˆ·ç±»å‹

**Request Body:**
```json
{
    "unique_identity": {
        "disease_id": "disease_000001"
    }
}
```

**å­—æ®µè¯´æ˜:**
- `unique_identity` (object, required): å¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ï¼Œé”®å€¼å¯¹å½¢å¼ï¼Œkey ä¸ºä¸»é”®å±æ€§åï¼Œvalue ä¸ºå±æ€§å€¼

#### 3.1.3 å“åº”æ ¼å¼

```json
{
    "_dynamic_tools": [
        {
            "name": "search_object_instance",
            "description": "è¯¥æ¥å£åŸºäºä¸šåŠ¡çŸ¥è¯†ç½‘ç»œè¯­ä¹‰æ£€ç´¢æ¥å£è¿”å›çš„å¯¹è±¡ç±»å®šä¹‰ï¼ŒæŸ¥è¯¢å…·ä½“çš„å¯¹è±¡å®ä¾‹æ•°æ®ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "kn_id": {
                        "type": "string",
                        "description": "ä¸šåŠ¡çŸ¥è¯†ç½‘ç»œID"
                    },
                    "ot_id": {
                        "type": "string",
                        "description": "å¯¹è±¡ç±»ID"
                    },
                    "condition": {
                        "type": "object",
                        "description": "è¿‡æ»¤æ¡ä»¶"
                    },
                    "limit": {
                        "type": "integer",
                        "description": "è¿”å›çš„æ•°é‡ï¼Œé»˜è®¤å€¼ 10ã€‚èŒƒå›´ 1-10000"
                    }
                },
                "required": ["kn_id", "ot_id", "limit"]
            },
            "api_url": "http://agent-operator-integration:9000/api/agent-operator-integration/internal-v1/tool-box/e59f35f8-65f3-46bb-b5f1-a428380b3edc/proxy/7acb8add-ecd0-45cf-bd4d-57674c3c69b0",
            "original_schema": {
                // å·¥å…·è¯¦æƒ…æ¥å£è¿”å›çš„ api_spec å®Œæ•´å†…å®¹
            },
            "fixed_params": {
                "header": {
                    "x-account-id": "test",
                    "x-account-type": "user"
                },
                "path": {},
                "query": {},
                "body": {}
            }
        }
    ]
}
```

**å­—æ®µè¯´æ˜:**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `_dynamic_tools` | array | åŠ¨æ€å·¥å…·åˆ—è¡¨ |
| `_dynamic_tools[].name` | string | å·¥å…·åç§°ï¼Œæ¥è‡ªå·¥å…·è¯¦æƒ…çš„ `name` å­—æ®µ |
| `_dynamic_tools[].description` | string | å·¥å…·æè¿°ï¼Œæ¥è‡ªå·¥å…·è¯¦æƒ…çš„ `description` å­—æ®µ |
| `_dynamic_tools[].parameters` | object | ç¬¦åˆ OpenAI Function Call è§„èŒƒçš„å‚æ•° Schema |
| `_dynamic_tools[].api_url` | string | å·¥å…·æ‰§è¡Œçš„ä»£ç† URLï¼Œæ ¼å¼è§ä¸‹æ–‡ |
| `_dynamic_tools[].original_schema` | object | å·¥å…·çš„åŸå§‹ OpenAPI å®šä¹‰ï¼ˆapi_specï¼‰ |
| `_dynamic_tools[].fixed_params` | object | å·²å®ä¾‹åŒ–çš„å›ºå®šå‚æ•°ï¼Œæ¥è‡ªè¡ŒåŠ¨æŸ¥è¯¢çš„ parameters |

---

## å››ã€æ ¸å¿ƒå¤„ç†é€»è¾‘

### 4.1 æ¥å£å°è£…é€»è¾‘

#### 4.1.1 è¯·æ±‚å‚æ•°è½¬æ¢
```
è¾“å…¥ï¼šunique_identity (å•ä¸ªå¯¹è±¡)
    â†“
è½¬æ¢ï¼šunique_identities: [unique_identity]
    â†“
è°ƒç”¨ï¼šè¡ŒåŠ¨æŸ¥è¯¢æ¥å£
```

#### 4.1.2 è¡ŒåŠ¨æºç±»å‹å¤„ç†

å½“å‰ç‰ˆæœ¬ä»…å¤„ç† `type=tool` çš„è¡ŒåŠ¨æºï¼š

```python
if action_source.type == "tool":
    # è°ƒç”¨å·¥å…·è¯¦æƒ…æ¥å£
    tool_detail = get_tool_detail(action_source.box_id, action_source.tool_id)
    # ç»§ç»­å¤„ç†
elif action_source.type == "mcp":
    # TODO: é¢„ç•™ MCP ç±»å‹å®ç°
    pass
```

#### 4.1.3 è¡ŒåŠ¨åˆ—è¡¨å¤„ç†è§„åˆ™

**é‡è¦çº¦æŸï¼šä»…å¤„ç† actions æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ **

```python
actions = response.get("actions", [])
if len(actions) > 0:
    first_action = actions[0]
    # ä»…å¤„ç† first_action
```

**åŸå› ï¼š**
- ç®€åŒ–é¦–ç‰ˆå®ç°é€»è¾‘
- actions æ•°ç»„ä¸­çš„å¤šä¸ªå…ƒç´ é€šå¸¸æ˜¯é’ˆå¯¹ä¸åŒå¯¹è±¡å®ä¾‹çš„åŒä¸€ä¸ªè¡ŒåŠ¨ï¼Œå–ç¬¬ä¸€ä¸ªä½œä¸ºä»£è¡¨å³å¯
- åç»­ç‰ˆæœ¬å¯æ ¹æ®å®é™…éœ€æ±‚æ‰©å±•æ”¯æŒå¤šä¸ª actions

### 4.2 URL ç”Ÿæˆè§„åˆ™

#### 4.2.1 API URL æ¨¡æ¿

```
http://agent-operator-integration:9000/api/agent-operator-integration/internal-v1/tool-box/{box_id}/proxy/{tool_id}
```

**å˜é‡æ¥æºï¼š**
- `box_id`: æ¥è‡ª `action_source.box_id`
- `tool_id`: æ¥è‡ª `action_source.tool_id`

#### 4.2.2 å®Œæ•´ç¤ºä¾‹

```json
{
    "action_source": {
        "type": "tool",
        "box_id": "e59f35f8-65f3-46bb-b5f1-a428380b3edc",
        "tool_id": "7acb8add-ecd0-45cf-bd4d-57674c3c69b0"
    }
}
```

ç”Ÿæˆçš„ URLï¼š
```
http://agent-operator-integration:9000/api/agent-operator-integration/internal-v1/tool-box/e59f35f8-65f3-46bb-b5f1-a428380b3edc/proxy/7acb8add-ecd0-45cf-bd4d-57674c3c69b0
```

### 4.3 å›ºå®šå‚æ•°æ˜ å°„

#### 4.3.1 å‚æ•°æ¥æº

å›ºå®šå‚æ•°æ¥è‡ªè¡ŒåŠ¨æŸ¥è¯¢æ¥å£è¿”å›çš„ `actions[0].parameters`

**ç¤ºä¾‹è¾“å…¥ï¼š**
```json
{
    "actions": [
        {
            "parameters": {
                "x-account-id": "test",
                "x-account-type": "user"
            },
            "dynamic_params": {
                "include_type_info": null,
                "condition": {...},
                "limit": null,
                "kn_id": null,
                "ot_id": null
            }
        }
    ]
}
```

**é‡è¦è¯´æ˜ï¼š**
- âœ… **å¤„ç† `parameters`**: è¿™äº›æ˜¯å·²å®ä¾‹åŒ–çš„å›ºå®šå‚æ•°ï¼Œéœ€è¦æ˜ å°„åˆ° `fixed_params`
- âŒ **å¿½ç•¥ `dynamic_params`**: è¿™äº›å‚æ•°ç”±å¤§æ¨¡å‹åŠ¨æ€ç”Ÿæˆï¼Œè¡ŒåŠ¨å¬å›æ¥å£ä¸å¤„ç†
- ğŸ“Œ `dynamic_params` ä¸­å€¼ä¸º `null` çš„å­—æ®µï¼Œè¡¨ç¤ºè¿™äº›å‚æ•°éœ€è¦ LLM æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€å¡«å……

#### 4.3.2 æ˜ å°„è§„åˆ™

**æ–¹æ¡ˆé€‰æ‹©ï¼šåŸºäº OpenAPI å®šä¹‰çš„ç²¾ç¡®æ˜ å°„ï¼ˆæ¨èï¼‰**

æ ¹æ® `original_schema.api_spec.parameters` çš„å®šä¹‰ï¼Œç²¾ç¡®åˆ¤æ–­æ¯ä¸ªå‚æ•°åº”è¯¥æ”¾åœ¨å“ªä¸ªä½ç½®ï¼š

```python
def map_parameters_by_schema(action_parameters, api_spec):
    """
    æ ¹æ® OpenAPI å®šä¹‰ç²¾ç¡®æ˜ å°„å‚æ•°ä½ç½®

    å¤„ç†é€»è¾‘ï¼š
    1. éå† api_spec.parametersï¼Œå»ºç«‹å‚æ•°å -> ä½ç½®(in) çš„æ˜ å°„è¡¨
    2. éå† action_parametersï¼Œæ ¹æ®æ˜ å°„è¡¨åˆ†ç±»åˆ°å¯¹åº”ä½ç½®
    3. ç‰¹æ®Šå¤„ç†ï¼š
       - path å‚æ•°ï¼šæ”¾å…¥ fixed_params.path
       - query å‚æ•°ï¼šæ”¾å…¥ fixed_params.query
       - header å‚æ•°ï¼šæ”¾å…¥ fixed_params.header
       - body å‚æ•°ï¼ˆrequest_bodyï¼‰ï¼šæ”¾å…¥ fixed_params.body
    """
    fixed_params = {"header": {}, "path": {}, "query": {}, "body": {}}

    # å»ºç«‹å‚æ•°ååˆ°ä½ç½®çš„æ˜ å°„è¡¨
    param_location_map = {}
    for param in api_spec.get("parameters", []):
        param_location_map[param["name"]] = param["in"]

    # æ ¹æ®æ˜ å°„è¡¨åˆ†ç±»å‚æ•°
    for key, value in action_parameters.items():
        location = param_location_map.get(key, "body")  # é»˜è®¤æ”¾ body
        fixed_params[location][key] = value

    return fixed_params
```

**å¤‡ç”¨æ–¹æ¡ˆï¼šç®€åŒ–æ˜ å°„ï¼ˆå¦‚æœ API Spec è§£æå›°éš¾ï¼‰**

æŒ‰ç…§å‘½åè§„åˆ™ç®€å•åˆ†ç±»ï¼š

```python
def map_parameters_by_naming(action_parameters):
    """
    æ ¹æ®å‚æ•°å‘½åè§„åˆ™ç®€åŒ–æ˜ å°„ï¼ˆfallback æ–¹æ¡ˆï¼‰
    """
    fixed_params = {"header": {}, "path": {}, "query": {}, "body": {}}

    for key, value in action_parameters.items():
        if key.startswith("x-") or key.lower() in ["authorization", "content-type"]:
            fixed_params["header"][key] = value
        else:
            fixed_params["body"][key] = value

    return fixed_params
```

**æœ€ç»ˆç”±è°ƒç”¨æ–¹å¤„ç†ï¼š**
- è¡ŒåŠ¨å¬å›æ¥å£æä¾› `fixed_params` å’Œ `original_schema`
- è°ƒç”¨æ–¹ï¼ˆAgent æˆ–ä¸­é—´å±‚ï¼‰æ ¹æ®è¿™ä¸¤è€…ï¼Œå°†å‚æ•°æ­£ç¡®ç»„è£…åˆ°å®é™…çš„ HTTP è¯·æ±‚ä¸­
- è¿™æ ·è®¾è®¡ä¿æŒäº†æ¥å£çš„ç®€å•æ€§ï¼ŒåŒæ—¶ç»™è°ƒç”¨æ–¹æœ€å¤§çš„çµæ´»æ€§

### 4.4 Schema è½¬æ¢é€»è¾‘ï¼ˆTODOï¼‰

#### 4.4.1 è½¬æ¢ç›®æ ‡

å°†å·¥å…·çš„ OpenAPI Schema è½¬æ¢ä¸º OpenAI Function Call çš„ Input Schema

**è¾“å…¥æ ¼å¼ï¼ˆOpenAPIï¼‰:**
```json
{
    "api_spec": {
        "parameters": [
            {
                "name": "kn_id",
                "in": "path",
                "description": "ä¸šåŠ¡çŸ¥è¯†ç½‘ç»œID",
                "required": true,
                "schema": {
                    "type": "string"
                }
            }
        ],
        "request_body": {
            "content": {
                "application/json": {
                    "schema": {
                        "$ref": "#/components/schemas/FirstQueryWithSearchAfter"
                    }
                }
            }
        },
        "components": {
            "schemas": {...}
        }
    }
}
```

**è¾“å‡ºæ ¼å¼ï¼ˆOpenAI Function Callï¼‰:**
```json
{
    "type": "object",
    "properties": {
        "kn_id": {
            "type": "string",
            "description": "ä¸šåŠ¡çŸ¥è¯†ç½‘ç»œID"
        },
        "condition": {
            "type": "object",
            "description": "è¿‡æ»¤æ¡ä»¶"
        }
    },
    "required": ["kn_id"]
}
```

#### 4.4.2 è½¬æ¢è§„åˆ™

**æ ¸å¿ƒåŸåˆ™ï¼ˆå·²æ¾„æ¸…ï¼‰ï¼š**
1. âœ… **æ‰å¹³åŒ–å¤„ç†**: å°† path/query/header/body ä¸­çš„æ‰€æœ‰å‚æ•°æ‰å¹³åŒ–åˆ°ä¸€ä¸ª properties å¯¹è±¡ä¸­
2. âœ… **ä¸ä¿ç•™ä½ç½®ä¿¡æ¯**: è½¬æ¢åçš„ schema ä¸éœ€è¦æ ‡è®°å‚æ•°æ¥è‡ªå“ªä¸ªä½ç½®ï¼ˆpath/query/header/bodyï¼‰
3. âœ… **å¿½ç•¥ dynamic_params**: ä¸å¤„ç† `dynamic_params`ï¼Œè¿™äº›ç”± LLM åŠ¨æ€ç”Ÿæˆ
4. âš ï¸ **$ref è§£æ**: é€’å½’è§£æ `$ref` å¼•ç”¨ï¼Œå±•å¼€ä¸ºå®Œæ•´çš„ schema å®šä¹‰ï¼ˆMVP ç‰ˆæœ¬å¯ç®€åŒ–å¤„ç†ï¼‰
5. âš ï¸ **å¿…å¡«é¡¹åˆå¹¶**: åˆå¹¶æ‰€æœ‰ä½ç½®çš„ required å‚æ•°åˆ°é¡¶å±‚ required æ•°ç»„
6. âœ… **ç±»å‹æ˜ å°„**: OpenAPI ç±»å‹ â†’ JSON Schema ç±»å‹çš„å¯¹åº”å…³ç³»

**å®ç°æ–¹å¼ï¼ˆMVP ç‰ˆæœ¬ï¼‰ï¼š**
```python
def convert_openapi_to_function_schema(api_spec):
    """
    OpenAPI Schema â†’ OpenAI Function Call Schema

    Args:
        api_spec: å·¥å…·è¯¦æƒ…æ¥å£è¿”å›çš„ api_spec

    Returns:
        ç¬¦åˆ OpenAI Function Call è§„èŒƒçš„ parameters schema
    """
    properties = {}
    required = []

    # 1. å¤„ç† parametersï¼ˆpath/query/headerï¼‰
    for param in api_spec.get("parameters", []):
        param_name = param["name"]
        param_schema = param.get("schema", {})

        properties[param_name] = {
            "type": param_schema.get("type", "string"),
            "description": param.get("description", "")
        }

        # å¤„ç†æšä¸¾
        if "enum" in param_schema:
            properties[param_name]["enum"] = param_schema["enum"]

        # æ”¶é›†å¿…å¡«å‚æ•°
        if param.get("required", False):
            required.append(param_name)

    # 2. å¤„ç† request_bodyï¼ˆbody å‚æ•°ï¼‰
    request_body = api_spec.get("request_body", {})
    if request_body:
        content = request_body.get("content", {}).get("application/json", {})
        body_schema = content.get("schema", {})

        # MVP: ç®€åŒ–å¤„ç†ï¼Œç›´æ¥åˆå¹¶ properties
        # TODO: å®Œæ•´ç‰ˆéœ€è¦é€’å½’è§£æ $ref
        if "$ref" in body_schema:
            # è·³è¿‡ $ref è§£æï¼Œæ ‡è®°ä¸º TODO
            # å¯ä»¥æ·»åŠ ä¸€ä¸ªé€šç”¨çš„ body å‚æ•°
            properties["body"] = {
                "type": "object",
                "description": "è¯·æ±‚ä½“å‚æ•°ï¼Œè¯¦è§ original_schema"
            }
        elif "properties" in body_schema:
            # ç›´æ¥å±•å¼€ properties
            for prop_name, prop_def in body_schema["properties"].items():
                properties[prop_name] = {
                    "type": prop_def.get("type", "string"),
                    "description": prop_def.get("description", "")
                }

            # åˆå¹¶å¿…å¡«é¡¹
            if "required" in body_schema:
                required.extend(body_schema["required"])

    return {
        "type": "object",
        "properties": properties,
        "required": required
    }
```

**å¾…åç»­å¢å¼ºçš„åŠŸèƒ½ï¼š**
- [ ] å®Œæ•´çš„ $ref é€’å½’è§£æï¼ˆä» components.schemas ä¸­æŸ¥æ‰¾å¹¶å±•å¼€ï¼‰
- [ ] å¤„ç† `allOf`, `oneOf`, `anyOf` ç­‰ç»„åˆ schema
- [ ] å¤„ç†å¤æ‚åµŒå¥—å¯¹è±¡çš„æ‰å¹³åŒ–ç­–ç•¥
- [ ] æ”¯æŒè‡ªå®šä¹‰çš„ schema è½¬æ¢è§„åˆ™

**è½¬æ¢ç¤ºä¾‹ï¼š**

è¾“å…¥ï¼ˆOpenAPIï¼‰ï¼š
```json
{
    "parameters": [
        {"name": "kn_id", "in": "path", "required": true, "schema": {"type": "string"}},
        {"name": "limit", "in": "query", "required": false, "schema": {"type": "integer"}}
    ],
    "request_body": {
        "content": {
            "application/json": {
                "schema": {
                    "properties": {
                        "condition": {"type": "object", "description": "è¿‡æ»¤æ¡ä»¶"}
                    }
                }
            }
        }
    }
}
```

è¾“å‡ºï¼ˆOpenAI Function Callï¼‰ï¼š
```json
{
    "type": "object",
    "properties": {
        "kn_id": {"type": "string", "description": ""},
        "limit": {"type": "integer", "description": ""},
        "condition": {"type": "object", "description": "è¿‡æ»¤æ¡ä»¶"}
    },
    "required": ["kn_id"]
}
```

---

## äº”ã€æ•°æ®æ¨¡å‹

### 5.1 è¯·æ±‚æ¨¡å‹

#### ActionRecallRequest
```python
class ActionRecallRequest(BaseModel):
    """è¡ŒåŠ¨å¬å›è¯·æ±‚"""
    unique_identity: Dict[str, Union[str, int, float, bool]]

    class Config:
        schema_extra = {
            "example": {
                "unique_identity": {
                    "disease_id": "disease_000001"
                }
            }
        }
```

### 5.2 å“åº”æ¨¡å‹

#### DynamicTool
```python
class DynamicTool(BaseModel):
    """åŠ¨æ€å·¥å…·å®šä¹‰"""
    name: str
    description: str
    parameters: Dict[str, Any]  # OpenAI Function Call Schema
    api_url: str
    original_schema: Dict[str, Any]  # åŸå§‹ OpenAPI Schema
    fixed_params: FixedParams
```

#### FixedParams
```python
class FixedParams(BaseModel):
    """å›ºå®šå‚æ•°"""
    header: Dict[str, Any] = {}
    path: Dict[str, Any] = {}
    query: Dict[str, Any] = {}
    body: Dict[str, Any] = {}
```

#### ActionRecallResponse
```python
class ActionRecallResponse(BaseModel):
    """è¡ŒåŠ¨å¬å›å“åº”"""
    _dynamic_tools: List[DynamicTool]

    class Config:
        schema_extra = {
            "example": {
                "_dynamic_tools": [
                    {
                        "name": "search_object_instance",
                        "description": "æŸ¥è¯¢å¯¹è±¡å®ä¾‹æ•°æ®",
                        "parameters": {...},
                        "api_url": "http://...",
                        "original_schema": {...},
                        "fixed_params": {...}
                    }
                ]
            }
        }
```

---

## å…­ã€å¼‚å¸¸å¤„ç†

### 6.1 å¼‚å¸¸åœºæ™¯

| åœºæ™¯ | HTTP çŠ¶æ€ç  | é”™è¯¯ç  | å¤„ç†æ–¹å¼ |
|------|------------|--------|---------|
| è¡ŒåŠ¨æŸ¥è¯¢æ¥å£è°ƒç”¨å¤±è´¥ | 502 | SERVICE_UNAVAILABLE | è¿”å›ä¸Šæ¸¸é”™è¯¯ä¿¡æ¯ |
| å·¥å…·è¯¦æƒ…æ¥å£è°ƒç”¨å¤±è´¥ | 502 | SERVICE_UNAVAILABLE | è¿”å›ä¸Šæ¸¸é”™è¯¯ä¿¡æ¯ |
| action_source.type ä¸æ”¯æŒ | 400 | UNSUPPORTED_ACTION_TYPE | è¿”å›é”™è¯¯æç¤ºï¼Œç›®å‰ä»…æ”¯æŒ tool |
| actions æ•°ç»„ä¸ºç©º | 200 | - | è¿”å›ç©ºçš„ _dynamic_tools æ•°ç»„ |
| unique_identity æ ¼å¼é”™è¯¯ | 400 | INVALID_REQUEST | è¿”å›å‚æ•°æ ¡éªŒé”™è¯¯ä¿¡æ¯ |
| Schema è½¬æ¢å¤±è´¥ | 500 | SCHEMA_CONVERSION_ERROR | è®°å½•é”™è¯¯æ—¥å¿—ï¼Œè¿”å›é€šç”¨é”™è¯¯ |

### 6.2 é”™è¯¯å“åº”æ ¼å¼

```json
{
    "code": "UNSUPPORTED_ACTION_TYPE",
    "message": "å½“å‰ä»…æ”¯æŒ type=tool çš„è¡ŒåŠ¨æº",
    "detail": {
        "action_source": {
            "type": "mcp",
            "box_id": "xxx",
            "tool_id": "yyy"
        }
    }
}
```

---

## ä¸ƒã€å®ç°è®¡åˆ’

### 7.1 ç¬¬ä¸€é˜¶æ®µï¼šMVPï¼ˆæœ€å°å¯è¡Œäº§å“ï¼‰

**ç›®æ ‡ï¼š** å®ç°åŸºæœ¬çš„è¡ŒåŠ¨å¬å›èƒ½åŠ›

**èŒƒå›´ï¼š**
- âœ… æ¥å£å®šä¹‰å’Œè·¯ç”±
- âœ… å‚æ•°è½¬æ¢ï¼ˆunique_identity â†’ unique_identitiesï¼‰
- âœ… è°ƒç”¨è¡ŒåŠ¨æŸ¥è¯¢æ¥å£
- âœ… è°ƒç”¨å·¥å…·è¯¦æƒ…æ¥å£ï¼ˆä»… type=toolï¼‰
- âœ… ä»…å¤„ç† actions[0]ï¼ˆç¬¬ä¸€ä¸ªè¡ŒåŠ¨ï¼‰
- âœ… ç”Ÿæˆ api_url
- âœ… fixed_params æ˜ å°„ï¼ˆåŸºäº OpenAPI å®šä¹‰æˆ–å‘½åè§„åˆ™ï¼‰
- âœ… å¿½ç•¥ dynamic_paramsï¼ˆç”± LLM åŠ¨æ€ç”Ÿæˆï¼‰
- âœ… åŸºç¡€çš„ Schema è½¬æ¢ï¼ˆæ‰å¹³åŒ– parameters å’Œç®€å•çš„ request_bodyï¼Œä¸ä¿ç•™ä½ç½®ä¿¡æ¯ï¼‰
- âœ… å¼‚å¸¸å¤„ç†ï¼ˆtype != tool æ—¶è¿”å›é”™è¯¯ï¼‰

**ä¸åŒ…å«ï¼š**
- âŒ å¤æ‚çš„ $ref é€’å½’è§£æ
- âŒ MCP ç±»å‹æ”¯æŒï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰
- âŒ å¤šä¸ª actions çš„å¤„ç†ï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰
- âŒ allOf/oneOf/anyOf ç­‰å¤æ‚ schema ç»„åˆ

### 7.2 ç¬¬äºŒé˜¶æ®µï¼šSchema è½¬æ¢å¢å¼º

**ç›®æ ‡ï¼š** å®ç°å®Œæ•´çš„ OpenAPI â†’ OpenAI Schema è½¬æ¢

**èŒƒå›´ï¼š**
- [ ] $ref é€’å½’è§£æï¼ˆä» components.schemas ä¸­æŸ¥æ‰¾å¹¶å±•å¼€ï¼‰
- [ ] å¤æ‚ schema ç±»å‹æ”¯æŒï¼ˆallOf, oneOf, anyOfï¼‰
- [ ] åµŒå¥—å¯¹è±¡çš„å®Œæ•´å±•å¼€
- [ ] Schema ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤è§£æï¼‰
- [ ] è½¬æ¢è§„åˆ™é…ç½®åŒ–ï¼ˆæ”¯æŒè‡ªå®šä¹‰æ˜ å°„è§„åˆ™ï¼‰
- [ ] Schema è½¬æ¢çš„å•å…ƒæµ‹è¯•è¦†ç›–

### 7.3 ç¬¬ä¸‰é˜¶æ®µï¼šæ‰©å±•æ”¯æŒ

**ç›®æ ‡ï¼š** æ”¯æŒæ›´å¤šè¡ŒåŠ¨æºç±»å‹å’Œé«˜çº§ç‰¹æ€§

**èŒƒå›´ï¼š**
- [ ] **MCP ç±»å‹è¡ŒåŠ¨æºæ”¯æŒ**ï¼ˆå·²æ˜ç¡®ä¸ºä¸‹ä¸ªç‰ˆæœ¬ï¼‰
  - å®šä¹‰ MCP ç±»å‹çš„æ¥å£è§„èŒƒ
  - å®ç° MCP å·¥å…·è¯¦æƒ…è·å–é€»è¾‘
  - é€‚é… MCP åˆ° OpenAI Function Call çš„è½¬æ¢
- [ ] **å¤šä¸ª actions çš„å¤„ç†ç­–ç•¥**ï¼ˆå·²æ˜ç¡®ä¸ºä¸‹ä¸ªç‰ˆæœ¬ï¼‰
  - æ”¯æŒ unique_identitiesï¼ˆå¤æ•°ï¼‰å…¥å‚
  - è¿”å›å¤šä¸ª _dynamic_tools
  - å¢åŠ  action_id æˆ–å…¶ä»–æ ‡è¯†åŒºåˆ†ä¸åŒçš„ action
- [ ] è¡ŒåŠ¨å¬å›ç»“æœç¼“å­˜ï¼ˆæå‡æ€§èƒ½ï¼‰
- [ ] å¯è§‚æµ‹æ€§å¢å¼ºï¼ˆæ—¥å¿—ã€ç›‘æ§ã€è¿½è¸ªï¼‰
- [ ] æ”¯æŒè¡ŒåŠ¨çš„æ¡ä»¶åŒ¹é…ï¼ˆæ ¹æ® action_type.condition æ™ºèƒ½é€‰æ‹©ï¼‰

---

## å…«ã€æŠ€æœ¯çº¦æŸä¸å‡è®¾

### 8.1 æŠ€æœ¯çº¦æŸ

1. **ä¾èµ–æœåŠ¡å¯ç”¨æ€§**: ä¾èµ– ontology-query å’Œ agent-operator-integration æœåŠ¡ç¨³å®šè¿è¡Œ
2. **Schema å…¼å®¹æ€§**: å‡è®¾å·¥å…·å®šä¹‰éµå¾ª OpenAPI 3.0 è§„èŒƒ
3. **ç½‘ç»œç¯å¢ƒ**: æœåŠ¡é—´é€šè¿‡å†…éƒ¨ç½‘ç»œé€šä¿¡ï¼ŒURL ä½¿ç”¨æœåŠ¡å

### 8.2 æŠ€æœ¯å‡è®¾

1. **å”¯ä¸€è¡ŒåŠ¨**: å‡è®¾ä¸€ä¸ªå¯¹è±¡çš„ä¸€ä¸ªè¡ŒåŠ¨ç±»å‹ï¼Œé€šå¸¸åªæœ‰ä¸€ä¸ªå…·ä½“çš„è¡ŒåŠ¨å®ç°ï¼ˆå› æ­¤åªå– actions[0]ï¼‰
2. **å‚æ•°æ¥æº**: å‡è®¾ actions[0].parameters ä¸­çš„å‚æ•°å·²ç»æ­£ç¡®å®ä¾‹åŒ–
3. **å·¥å…·å¯ç”¨æ€§**: å‡è®¾ action_source ä¸­å¼•ç”¨çš„å·¥å…·åœ¨å·¥å…·ç®±ä¸­ç¡®å®å­˜åœ¨ä¸”å¯ç”¨
4. **å‚æ•°èŒè´£åˆ†ç¦»**:
   - `parameters` (fixed_params) ç”±è¡ŒåŠ¨æŸ¥è¯¢æ¥å£å®ä¾‹åŒ–
   - `dynamic_params` ç”± LLM æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€ç”Ÿæˆ
   - è°ƒç”¨æ–¹è´Ÿè´£åˆå¹¶ä¸¤è€…å¹¶ç»„è£…æœ€ç»ˆè¯·æ±‚
5. **è°ƒç”¨æ–¹èƒ½åŠ›**: å‡è®¾è°ƒç”¨æ–¹æœ‰èƒ½åŠ›æ ¹æ® `original_schema` å’Œ `fixed_params` ç»„è£…æ­£ç¡®çš„ HTTP è¯·æ±‚

---

## ä¹ã€æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

- [ ] å‚æ•°è½¬æ¢é€»è¾‘
- [ ] URL ç”Ÿæˆé€»è¾‘
- [ ] Fixed params æ˜ å°„é€»è¾‘
- [ ] Schema è½¬æ¢é€»è¾‘ï¼ˆå„ç§è¾¹ç•Œæƒ…å†µï¼‰

### 9.2 é›†æˆæµ‹è¯•

- [ ] å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆmock ä¾èµ–æœåŠ¡ï¼‰
- [ ] å¼‚å¸¸åœºæ™¯æµ‹è¯•ï¼ˆä¾èµ–æœåŠ¡ä¸å¯ç”¨ã€è¿”å›é”™è¯¯ç­‰ï¼‰
- [ ] ä¸åŒ action_source.type çš„æµ‹è¯•

### 9.3 ç«¯åˆ°ç«¯æµ‹è¯•

- [ ] çœŸå®ç¯å¢ƒä¸‹çš„å®Œæ•´è°ƒç”¨é“¾è·¯æµ‹è¯•
- [ ] ä¸ Agent ç³»ç»Ÿçš„é›†æˆæµ‹è¯•

---

## åã€å¾…æ¾„æ¸…é—®é¢˜

### 10.1 Schema è½¬æ¢ç›¸å…³

1. **Q1**: dynamic_params çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä¸ parameters æœ‰ä½•åŒºåˆ«ï¼Ÿ
   - âœ… **å·²æ¾„æ¸…**: `dynamic_params` è¡¨ç¤ºéœ€è¦ç”±å¤§æ¨¡å‹åŠ¨æ€ç”Ÿæˆçš„å‚æ•°
   - **ç»“è®º**: æˆ‘ä»¬ä¸éœ€è¦è§£æ `dynamic_params`ï¼Œè¿™éƒ¨åˆ†ç”± LLM æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€å¡«å……
   - **å®ç°å½±å“**: åœ¨è¡ŒåŠ¨å¬å›æ¥å£ä¸­ï¼Œä»…å¤„ç† `actions[0].parameters`ï¼ˆå›ºå®šå‚æ•°ï¼‰ï¼Œå¿½ç•¥ `dynamic_params`

2. **Q2**: å¦‚ä½•åˆ¤æ–­å‚æ•°åº”è¯¥æ”¾åœ¨ header/path/query/body çš„å“ªä¸ªä½ç½®ï¼Ÿ
   - âœ… **å·²æ¾„æ¸…**: å‚æ•°ä½ç½®åˆ¤æ–­äº¤ç»™è°ƒç”¨æ–¹å¤„ç†
   - **ç»“è®º**: è¡ŒåŠ¨å¬å›æ¥å£ä¸è´Ÿè´£åˆ¤æ–­å‚æ•°ä½ç½®ï¼Œä»…å°† `fixed_params` æŒ‰ç…§ç°æœ‰ç»“æ„ï¼ˆheader/path/query/bodyï¼‰è¿”å›ç»™è°ƒç”¨æ–¹
   - **å®ç°å½±å“**:
     - ä¿æŒç®€åŒ–çš„æ˜ å°„é€»è¾‘ï¼ˆå¦‚ x- å¼€å¤´æ”¾ headerï¼Œå…¶ä½™æ”¾ bodyï¼‰
     - æˆ–è€…æ ¹æ® `api_spec.parameters[].in` è¿›è¡Œå‡†ç¡®æ˜ å°„
     - æœ€ç»ˆç”±è°ƒç”¨æ–¹ï¼ˆAgent æˆ–ä¸­é—´å±‚ï¼‰æ ¹æ® `original_schema` å’Œ `fixed_params` ç»„è£…å®é™…è¯·æ±‚

3. **Q3**: è½¬æ¢åçš„ parameters schema éœ€è¦ä¿ç•™å‚æ•°ä½ç½®ä¿¡æ¯å—ï¼Ÿ
   - âœ… **å·²æ¾„æ¸…**: ä¸éœ€è¦ä¿ç•™å‚æ•°ä½ç½®ä¿¡æ¯
   - **ç»“è®º**: OpenAI Function Call çš„ `parameters` schema åªéœ€è¦æ‰å¹³åŒ–çš„å‚æ•°å®šä¹‰ï¼Œä¸éœ€è¦æ ‡è®°å‚æ•°æ¥è‡ª path/query/header/body
   - **å®ç°å½±å“**: Schema è½¬æ¢æ—¶ï¼Œå°†æ‰€æœ‰å‚æ•°æ‰å¹³åŒ–åˆ°ä¸€ä¸ª `properties` å¯¹è±¡ä¸­å³å¯

### 10.2 è¡ŒåŠ¨å¬å›ç›¸å…³

4. **Q4**: actions æ•°ç»„æœ‰å¤šä¸ªå…ƒç´ æ—¶ï¼Œä¸ºä»€ä¹ˆåªå–ç¬¬ä¸€ä¸ªï¼Ÿ
   - âœ… **å·²æ¾„æ¸…**: å½“å‰ç‰ˆæœ¬æš‚æ—¶åªæ”¯æŒå•ä¸ª action çš„æƒ…å†µ
   - **ç»“è®º**: è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå…¥å‚ä½¿ç”¨ `unique_identity`ï¼ˆå•æ•°ï¼‰è€Œä¸æ˜¯ `unique_identities`ï¼ˆå¤æ•°ï¼‰çš„åŸå› 
   - **è®¾è®¡åˆç†æ€§**:
     - ä¸€ä¸ªå¯¹è±¡çš„ä¸€ä¸ªè¡ŒåŠ¨ç±»å‹ï¼Œé€šå¸¸å¯¹åº”ä¸€ä¸ªå…·ä½“çš„å·¥å…·
     - å¦‚æœæœ‰å¤šä¸ª actionsï¼Œè¯´æ˜å¯èƒ½æ˜¯é’ˆå¯¹ä¸åŒæ¡ä»¶æˆ–åœºæ™¯çš„å˜ä½“ï¼Œé¦–ç‰ˆå–ç¬¬ä¸€ä¸ªå³å¯æ»¡è¶³éœ€æ±‚
   - **åç»­æ‰©å±•**: å¦‚æœæœªæ¥éœ€è¦æ”¯æŒå¤šä¸ª actionsï¼Œå¯ä»¥è€ƒè™‘ï¼š
     - æ–¹æ¡ˆ A: è¿”å›å¤šä¸ª `_dynamic_tools`ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ª action
     - æ–¹æ¡ˆ B: å¢åŠ æ¡ä»¶åŒ¹é…é€»è¾‘ï¼Œæ™ºèƒ½é€‰æ‹©æœ€åˆé€‚çš„ action

5. **Q5**: MCP ç±»å‹çš„è¡ŒåŠ¨æºé¢„æœŸä½•æ—¶æ”¯æŒï¼Ÿ
   - âœ… **å·²æ¾„æ¸…**: ä¸‹ä¸ªç‰ˆæœ¬å†æ”¯æŒï¼Œå½“å‰ä¸åš
   - **ç»“è®º**: ç¬¬ä¸€ç‰ˆæœ¬ï¼ˆMVPï¼‰ä»…æ”¯æŒ `type=tool`ï¼Œé‡åˆ° `type=mcp` è¿”å›é”™è¯¯æç¤º
   - **å®ç°å½±å“**:
     - ä»£ç ä¸­é¢„ç•™ MCP ç±»å‹çš„å¤„ç†åˆ†æ”¯ï¼ˆè¿”å› `UNSUPPORTED_ACTION_TYPE` é”™è¯¯ï¼‰
     - åœ¨æ¥å£æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜å½“å‰ä»…æ”¯æŒ tool ç±»å‹

### 10.3 å·¥å…·æ‰§è¡Œç›¸å…³

6. **Q6**: Agent è°ƒç”¨ api_url æ—¶ï¼Œå¦‚ä½•ä¼ é€’å‚æ•°ï¼Ÿ
   - âš ï¸ **éƒ¨åˆ†æ¾„æ¸…**:
     - `fixed_params`: å·²å®ä¾‹åŒ–çš„å›ºå®šå‚æ•°ï¼ˆæ¥è‡ª `actions[0].parameters`ï¼‰
     - åŠ¨æ€å‚æ•°: ç”± LLM æ ¹æ® `parameters` schema ç”Ÿæˆ
   - **æ¨èæ–¹æ¡ˆ**:
     - è°ƒç”¨æ–¹å°† LLM ç”Ÿæˆçš„å‚æ•°ä¸ `fixed_params` åˆå¹¶
     - ä¼˜å…ˆçº§: LLM åŠ¨æ€å‚æ•° > fixed_paramsï¼ˆå…è®¸ LLM è¦†ç›–å›ºå®šå‚æ•°ï¼‰
     - æ ¹æ® `original_schema` åˆ¤æ–­æ¯ä¸ªå‚æ•°åº”è¯¥æ”¾åœ¨è¯·æ±‚çš„å“ªä¸ªä½ç½®
   - **å¾…è¿›ä¸€æ­¥ç¡®è®¤**: å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨ä¸‹ä¸€æ¬¡è¿­ä»£ä¸­æä¾›å‚æ•°åˆå¹¶çš„è¾…åŠ©å·¥å…·æˆ–ç¤ºä¾‹ä»£ç 

---

## åä¸€ã€é™„å½•

### 11.1 å®Œæ•´è¯·æ±‚å“åº”ç¤ºä¾‹

#### è¯·æ±‚ç¤ºä¾‹

```bash
curl --location 'http://action-recall-svc:8000/api/action-recall/v1/knowledge-networks/kn_medical/action-types/generate_treatment_plan/recall' \
--header 'x-account-id: bdb78b62-6c48-11f0-af96-fa8dcc0a06b2' \
--header 'x-account-type: user' \
--header 'Content-Type: application/json' \
--data '{
    "unique_identity": {
        "disease_id": "disease_000001"
    }
}'
```

#### å“åº”ç¤ºä¾‹

```json
{
    "_dynamic_tools": [
        {
            "name": "æ ¹æ®å•ä¸ªå¯¹è±¡ç±»æŸ¥è¯¢å¯¹è±¡å®ä¾‹",
            "description": "è¯¥æ¥å£åŸºäºä¸šåŠ¡çŸ¥è¯†ç½‘ç»œè¯­ä¹‰æ£€ç´¢æ¥å£è¿”å›çš„å¯¹è±¡ç±»å®šä¹‰ï¼ŒæŸ¥è¯¢å…·ä½“çš„å¯¹è±¡å®ä¾‹æ•°æ®ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "kn_id": {
                        "type": "string",
                        "description": "ä¸šåŠ¡çŸ¥è¯†ç½‘ç»œID"
                    },
                    "ot_id": {
                        "type": "string",
                        "description": "å¯¹è±¡ç±»ID"
                    },
                    "include_type_info": {
                        "type": "boolean",
                        "description": "æ˜¯å¦åŒ…å«å¯¹è±¡ç±»ä¿¡æ¯, é»˜è®¤falseï¼Œä¸åŒ…å«"
                    },
                    "include_logic_params": {
                        "type": "boolean",
                        "description": "åŒ…å«é€»è¾‘å±æ€§çš„è®¡ç®—å‚æ•°ï¼Œé»˜è®¤false"
                    },
                    "condition": {
                        "type": "object",
                        "description": "è¿‡æ»¤æ¡ä»¶"
                    },
                    "limit": {
                        "type": "integer",
                        "description": "è¿”å›çš„æ•°é‡ï¼Œé»˜è®¤å€¼ 10ã€‚èŒƒå›´ 1-10000"
                    },
                    "sort": {
                        "type": "array",
                        "description": "æ’åºå­—æ®µ",
                        "items": {
                            "type": "object",
                            "properties": {
                                "field": {
                                    "type": "string"
                                },
                                "direction": {
                                    "type": "string",
                                    "enum": ["asc", "desc"]
                                }
                            }
                        }
                    }
                },
                "required": ["kn_id", "ot_id"]
            },
            "api_url": "http://agent-operator-integration:9000/api/agent-operator-integration/internal-v1/tool-box/e59f35f8-65f3-46bb-b5f1-a428380b3edc/proxy/7acb8add-ecd0-45cf-bd4d-57674c3c69b0",
            "original_schema": {
                "parameters": [...],
                "request_body": {...},
                "components": {...}
            },
            "fixed_params": {
                "header": {
                    "x-account-id": "test",
                    "x-account-type": "user",
                    "X-HTTP-Method-Override": "GET"
                },
                "path": {},
                "query": {},
                "body": {}
            }
        }
    ]
}
```

### 11.2 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| è¡ŒåŠ¨ (Action) | é’ˆå¯¹ç‰¹å®šå¯¹è±¡å¯æ‰§è¡Œçš„æ“ä½œï¼Œé€šå¸¸ç»‘å®šåˆ°æŸä¸ªå·¥å…·æˆ–æœåŠ¡ |
| è¡ŒåŠ¨ç±»å‹ (Action Type) | è¡ŒåŠ¨çš„åˆ†ç±»ï¼Œå¦‚"ç”Ÿæˆæ²»ç–—æ–¹æ¡ˆ"ã€"æ›´æ–°æ•°æ®"ç­‰ |
| è¡ŒåŠ¨æº (Action Source) | è¡ŒåŠ¨çš„å®é™…æ‰§è¡Œè½½ä½“ï¼Œå¯ä»¥æ˜¯ toolã€mcp ç­‰ç±»å‹ |
| å¯¹è±¡å”¯ä¸€æ ‡è¯† (Unique Identity) | å¯¹è±¡å®ä¾‹çš„ä¸»é”®ä¿¡æ¯ï¼Œç”¨äºå”¯ä¸€ç¡®å®šä¸€ä¸ªå¯¹è±¡ |
| åŠ¨æ€å·¥å…· (Dynamic Tool) | è¿è¡Œæ—¶åŠ¨æ€å‘ç°å’Œç”Ÿæˆçš„å·¥å…·å®šä¹‰ï¼Œè€Œéé¢„å…ˆæ³¨å†Œçš„é™æ€å·¥å…· |
| Function Call | OpenAI å®šä¹‰çš„å‡½æ•°è°ƒç”¨è§„èŒƒï¼ŒLLM å¯ä»¥æ ¹æ®æ­¤è§„èŒƒè°ƒç”¨å¤–éƒ¨å·¥å…· |
| OpenAPI | RESTful API çš„æ ‡å‡†åŒ–æè¿°è§„èŒƒï¼ˆåŸå Swaggerï¼‰ |

### 11.3 å‚è€ƒèµ„æ–™

- [OpenAPI 3.0 è§„èŒƒ](https://swagger.io/specification/)
- [OpenAI Function Calling æ–‡æ¡£](https://platform.openai.com/docs/guides/function-calling)
- ontology-query æœåŠ¡æ¥å£æ–‡æ¡£: `docs/prd/feature-799472/99-ä¾èµ–æ¥å£/ontology_query_action.yaml`
- operator-toolbox æœåŠ¡æ¥å£æ–‡æ¡£: `docs/prd/feature-799472/99-ä¾èµ–æ¥å£/operator_toolbox.yaml`

---

## æ–‡æ¡£å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|---------|
| v1.0 | 2025-12-23 | - | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäºåŸå§‹éœ€æ±‚æ•´ç† |
| v1.1 | 2025-12-23 | - | æ¾„æ¸…å…³é”®é—®é¢˜ï¼Œæ›´æ–°è®¾è®¡å†³ç­–å’Œå®ç°è®¡åˆ’ |

### v1.1 å˜æ›´è¯¦æƒ…

**æ¾„æ¸…çš„é—®é¢˜ï¼š**
1. âœ… **dynamic_params ä¸éœ€è¦å¤„ç†**ï¼šç”± LLM åŠ¨æ€ç”Ÿæˆï¼Œè¡ŒåŠ¨å¬å›æ¥å£å¿½ç•¥
2. âœ… **å‚æ•°ä½ç½®åˆ¤æ–­äº¤ç»™è°ƒç”¨æ–¹**ï¼šæ¥å£åªè¿”å›å…ƒæ•°æ®ï¼Œè°ƒç”¨æ–¹è´Ÿè´£ç»„è£…è¯·æ±‚
3. âœ… **Schema ä¸ä¿ç•™ä½ç½®ä¿¡æ¯**ï¼šæ‰å¹³åŒ–å¤„ç†ï¼Œç¬¦åˆ OpenAI Function Call è§„èŒƒ
4. âœ… **ä»…å¤„ç† actions[0]**ï¼šå½“å‰ç‰ˆæœ¬åªæ”¯æŒå•ä¸ª actionï¼Œä½¿ç”¨ unique_identityï¼ˆå•æ•°ï¼‰å…¥å‚
5. âœ… **MCP ç±»å‹ä¸‹ä¸ªç‰ˆæœ¬æ”¯æŒ**ï¼šå½“å‰ç‰ˆæœ¬é‡åˆ° MCP è¿”å›é”™è¯¯æç¤º

**æ–°å¢å†…å®¹ï¼š**
- 2.3 å…³é”®è®¾è®¡å†³ç­–ç« èŠ‚ï¼Œè§£é‡Šæ ¸å¿ƒè®¾è®¡ç†ç”±
- 4.3.1 è¡¥å…… dynamic_params è¯´æ˜
- 4.3.2 æä¾›åŸºäº OpenAPI å®šä¹‰çš„ç²¾ç¡®æ˜ å°„æ–¹æ¡ˆ
- 4.4.2 å®Œå–„ Schema è½¬æ¢è§„åˆ™å’Œç¤ºä¾‹ä»£ç 
- ç¬¬åç« å¾…æ¾„æ¸…é—®é¢˜å…¨éƒ¨æ›´æ–°ä¸ºå·²æ¾„æ¸…çŠ¶æ€

**è°ƒæ•´å†…å®¹ï¼š**
- 7.1 MVP èŒƒå›´æ›´æ˜ç¡®ï¼Œå¢åŠ "å¿½ç•¥ dynamic_params"ç­‰æ¡ç›®
- 7.3 ç¬¬ä¸‰é˜¶æ®µæ˜ç¡® MCP å’Œå¤š actions æ”¯æŒä¸ºä¸‹ä¸ªç‰ˆæœ¬

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ¾„æ¸…æ ¸å¿ƒé—®é¢˜ï¼Œå¾…æŠ€æœ¯è¯„å®¡

**ä¼˜å…ˆçº§**: P0 (æ ¸å¿ƒåŠŸèƒ½)

**é¢„è®¡å·¥ä½œé‡**:
- MVP (ç¬¬ä¸€é˜¶æ®µ): 3-5 äººæ—¥
- Schema è½¬æ¢å¢å¼º (ç¬¬äºŒé˜¶æ®µ): 5-8 äººæ—¥
- æ‰©å±•æ”¯æŒ (ç¬¬ä¸‰é˜¶æ®µ): 3-5 äººæ—¥

